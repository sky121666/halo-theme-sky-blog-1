const u="steam_page_cache";const $={get(e){try{const t=localStorage.getItem(`${u}_${e}`);if(!t)return null;const{value:s,expiry:a}=JSON.parse(t);return Date.now()>a?(console.log(`[Steam Page] ç¼“å­˜è¿‡æœŸ: ${e}`),localStorage.removeItem(`${u}_${e}`),null):(console.log(`[Steam Page] å‘½ä¸­ç¼“å­˜: ${e}`),s)}catch{return null}},set(e,t){try{localStorage.setItem(`${u}_${e}`,JSON.stringify({value:t,expiry:Date.now()+18e4})),console.log(`[Steam Page] å†™å…¥ç¼“å­˜: ${e}`)}catch(s){console.warn("[Steam Page] ç¼“å­˜å†™å…¥å¤±è´¥:",s)}}};async function p(e,t=!0){const s=e.replace(/[^a-z0-9]/gi,"_");if(t){const c=$.get(s);if(c)return c}console.log(`[Steam Page] è¯·æ±‚ API: ${e}`);const a=performance.now(),r=await fetch(`/apis/api.steam.halo.run/v1alpha1${e}`),o=(performance.now()-a).toFixed(0);if(console.log(`[Steam Page] API å“åº”: ${e} - ${r.status} (${o}ms)`),!r.ok)throw new Error(`API error: ${r.status}`);const n=await r.json();return t&&$.set(s,n),n}document.addEventListener("alpine:init",()=>{Alpine._steamPageRegistered||(Alpine._steamPageRegistered=!0,Alpine.data("steamPage",()=>({profile:null,stats:null,badges:null,recentGames:[],games:{items:[],page:1,totalPages:1},error:null,_initialized:!1,loading:{profile:!0,stats:!0,badges:!0,recent:!0,games:!0},config:window.steamPageConfig||{},async init(){if(this._initialized){console.log("[Steam Page] è·³è¿‡é‡å¤åˆå§‹åŒ–");return}this._initialized=!0,console.log("[Steam Page] åˆå§‹åŒ–å¼€å§‹");const e=performance.now();await Promise.all([this.loadProfile(),this.loadStats(),this.loadBadges(),this.loadRecent(),this.loadGames(1)]),console.log(`[Steam Page] æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ, æ€»è€—æ—¶: ${(performance.now()-e).toFixed(0)}ms`),console.log("[Steam Page] æ•°æ®çŠ¶æ€:",{profile:!!this.profile,stats:!!this.stats,badges:!!this.badges,recentGames:this.recentGames?.length||0,games:this.games?.items?.length||0}),this.$nextTick(()=>{D()})},async loadProfile(){try{this.profile=await p("/profile"),console.log("[Steam Page] profile åŠ è½½æˆåŠŸ:",this.profile?.summary?.personaname)}catch(e){console.error("[Steam Page] profile åŠ è½½å¤±è´¥:",e),this.error="Steam èµ„æ–™åŠ è½½å¤±è´¥"}finally{this.loading.profile=!1}},async loadStats(){try{this.stats=await p("/stats"),console.log("[Steam Page] stats åŠ è½½æˆåŠŸ:",{totalGames:this.stats?.totalGames})}catch(e){console.error("[Steam Page] stats åŠ è½½å¤±è´¥:",e)}finally{this.loading.stats=!1}},async loadBadges(){try{this.badges=await p("/badges"),console.log("[Steam Page] badges åŠ è½½æˆåŠŸ:",{totalBadges:this.badges?.totalBadges})}catch(e){console.error("[Steam Page] badges åŠ è½½å¤±è´¥:",e)}finally{this.loading.badges=!1}},async loadRecent(){try{const e=this.config.recentGamesLimit||10,t=await p(`/recent?limit=${e}`);this.recentGames=Array.isArray(t)?t:[],console.log("[Steam Page] recent åŠ è½½æˆåŠŸ:",{count:this.recentGames.length}),this.recentGames.forEach((s,a)=>{(!s.appid||!s.headerImageUrl)&&console.warn(`[Steam Page] recent[${a}] æ•°æ®ä¸å®Œæ•´:`,{appid:s.appid,headerImageUrl:s.headerImageUrl,name:s.name})})}catch(e){console.error("[Steam Page] recent åŠ è½½å¤±è´¥:",e),this.recentGames=[]}finally{this.loading.recent=!1}},async loadGames(e=1){this.loading.games=!0;try{const t=this.config.gamesPageSize||20;console.log(`[Steam Page] åŠ è½½æ¸¸æˆåº“ page=${e}, size=${t}`);const s=await p(`/games?page=${e}&size=${t}`,!1);this.games=s||{items:[],page:1,totalPages:1},console.log("[Steam Page] games åŠ è½½æˆåŠŸ:",{page:this.games?.page,total:this.games?.total,items:this.games?.items?.length}),this.games?.items&&this.games.items.forEach((a,r)=>{(!a.appid||!a.headerImageUrl)&&console.warn(`[Steam Page] games[${r}] æ•°æ®ä¸å®Œæ•´:`,{appid:a.appid,headerImageUrl:a.headerImageUrl,name:a.name})})}catch(t){console.error("[Steam Page] games åŠ è½½å¤±è´¥:",t),this.games={items:[],page:1,totalPages:1}}finally{this.loading.games=!1}},getAchievementPercent(e){if(!e)return 0;const t=e.match(/(\d+)\s*\/\s*(\d+)/);if(t){const[,s,a]=t;return a>0?s/a*100:0}return 0}})))});document.addEventListener("DOMContentLoaded",()=>{E()});function E(){new MutationObserver(t=>{t.forEach(s=>{s.addedNodes.forEach(a=>{a.nodeType===1&&((a.querySelectorAll?.(".steam-game-img, .steam-badge-img, .steam-avatar-img")||[]).forEach(y),a.matches?.(".steam-game-img, .steam-badge-img, .steam-avatar-img")&&y(a))})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".steam-game-img, .steam-badge-img, .steam-avatar-img").forEach(y)}function y(e){e.dataset.handled||(e.dataset.handled="true",e.src||e.getAttribute(":src"),e.complete&&e.naturalHeight!==0?e.classList.add("loaded"):(e.addEventListener("load",function(){this.classList.add("loaded")}),e.addEventListener("error",function(){if(!this.src||this.src===window.location.href||this.src.endsWith("/steam")){console.log("[Steam Page] å¿½ç•¥æ— æ•ˆå›¾ç‰‡ src:",this.src);return}console.warn("[Steam Page] å›¾ç‰‡åŠ è½½å¤±è´¥:",this.src),this.classList.add("loaded"),this.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460 215"%3E%3Crect fill="%231b2838" width="460" height="215"/%3E%3Ctext x="50%25" y="50%25" fill="%2366c0f4" font-size="24" text-anchor="middle" dy=".3em"%3EğŸ®%3C/text%3E%3C/svg%3E'})))}async function D(){const e=document.getElementById("steam-heatmap-grid"),t=document.getElementById("steam-heatmap-loading"),s=document.getElementById("steam-heatmap-empty"),a=document.getElementById("steam-heatmap-error"),r=document.getElementById("steam-heatmap-tooltip");if(!e){console.log("[Steam Page] çƒ­åŠ›å›¾å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡");return}console.log("[Steam Page] å¼€å§‹åŠ è½½çƒ­åŠ›å›¾");try{const o=parseInt(e.dataset.days||"365",10),n=e.dataset.apiUrl;if(!n){console.log("[Steam Page] çƒ­åŠ›å›¾ API URL æœªé…ç½®"),t&&(t.style.display="none"),s&&(s.style.display="flex");return}console.log(`[Steam Page] çƒ­åŠ›å›¾è¯·æ±‚: ${n}, days=${o}`);const c=performance.now(),g=await b(n,o);if(console.log(`[Steam Page] çƒ­åŠ›å›¾æ•°æ®è·å–å®Œæˆ, è€—æ—¶: ${(performance.now()-c).toFixed(0)}ms, è®°å½•æ•°: ${g?.items?.length||0}`),t&&(t.style.display="none"),!g||!g.items||g.items.length===0){console.log("[Steam Page] çƒ­åŠ›å›¾æ— æ•°æ®"),s&&(s.style.display="flex");return}const i=new Map;g.items.forEach(l=>{const h=l.spec.date,m=l.spec.playtimeMinutes||0;i.set(h,(i.get(h)||0)+m)}),x(e,i,o,r),console.log("[Steam Page] çƒ­åŠ›å›¾æ¸²æŸ“å®Œæˆ")}catch(o){console.error("[Steam Page] çƒ­åŠ›å›¾åŠ è½½å¤±è´¥:",o),t&&(t.style.display="none"),a&&(a.style.display="flex")}}async function b(e,t){const s=new Date,a=new Date;a.setDate(a.getDate()-t);const r=c=>{const g=c.getFullYear(),i=String(c.getMonth()+1).padStart(2,"0"),l=String(c.getDate()).padStart(2,"0");return`${g}-${i}-${l}`},o=new URL(e,window.location.origin);o.searchParams.set("startDate",r(a)),o.searchParams.set("endDate",r(s)),o.searchParams.set("page","1"),o.searchParams.set("size",t);const n=await fetch(o.toString());if(!n.ok)throw new Error("Failed to fetch heatmap data");return await n.json()}function x(e,t,s,a){const r=new Date,o=new Date;o.setDate(o.getDate()-s),e.innerHTML="";let n=new Date(o);const c=n.getDay();n.setDate(n.getDate()-c);const g=i=>{const l=i.getFullYear(),h=String(i.getMonth()+1).padStart(2,"0"),m=String(i.getDate()).padStart(2,"0");return`${l}-${h}-${m}`};for(;n<=r;){const i=g(n),l=t.get(i)||0,h=(l/60).toFixed(1);let m=0;l>0&&(m=1),l>120&&(m=2),l>240&&(m=3);let f;m===0?f="color-mix(in oklch, var(--color-base-content) 10%, transparent)":m===1?f="color-mix(in oklch, var(--color-primary) 30%, transparent)":m===2?f="color-mix(in oklch, var(--color-primary) 60%, transparent)":f="var(--color-primary)";const d=document.createElement("div");d.className="steam-heatmap-cell",d.style.backgroundColor=f,d.dataset.date=i,d.dataset.hours=h,d.dataset.minutes=l,d.addEventListener("mouseenter",P=>{const S=new Date(i),v=`${S.getMonth()+1}æœˆ${S.getDate()}æ—¥`;a.innerHTML=`
        <div style="font-weight:600;margin-bottom:4px;">${v}</div>
        <div style="opacity:0.9;">${h} å°æ—¶</div>
      `;const w=e.closest(".steam-layout")?.getBoundingClientRect()||{left:0,top:0};a.style.display="block",a.style.left=P.clientX-w.left+10+"px",a.style.top=P.clientY-w.top-50+"px"}),d.addEventListener("mouseleave",()=>{a.style.display="none"}),e.appendChild(d),n.setDate(n.getDate()+1)}}
