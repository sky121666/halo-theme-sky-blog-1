document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".steam-game-img, .steam-badge-img, .steam-avatar-img").forEach(n=>{n.complete&&n.naturalHeight!==0?n.classList.add("loaded"):(n.addEventListener("load",function(){this.classList.add("loaded")}),n.addEventListener("error",function(){this.classList.add("loaded"),this.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460 215"%3E%3Crect fill="%231b2838" width="460" height="215"/%3E%3Ctext x="50%25" y="50%25" fill="%2366c0f4" font-size="24" text-anchor="middle" dy=".3em"%3EğŸ®%3C/text%3E%3C/svg%3E'}))}),w(),S()});function w(){document.querySelectorAll(".steam-achievement-bar[data-progress]").forEach(a=>{const e=a.dataset.progress;if(!e)return;const n=e.match(/(\d+)\s*\/\s*(\d+)/);if(n){const s=parseInt(n[1],10),l=parseInt(n[2],10);if(l>0){const o=s/l*100,t=a.querySelector(".steam-achievement-fill");t&&requestAnimationFrame(()=>{t.style.width=`${o}%`})}}})}function E(a,e){if(e||(e=document.getElementById("steam-tooltip")),!e)return;a.querySelectorAll(".steam-heatmap-cell:not(.invisible)").forEach(s=>{const l=s.dataset.date,t=(parseInt(s.dataset.minutes||"0",10)/60).toFixed(1);s.addEventListener("mouseenter",()=>{const c=new Date(l),i=["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"],d=`${c.getMonth()+1}æœˆ${c.getDate()}æ—¥${i[c.getDay()]}`;e.innerHTML=`
        <div class="font-bold text-base-content/90">${d}</div>
        <div class="text-base-content/70 mt-1 flex items-center gap-1">
          <span class="font-mono text-sm">${t}</span> <span class="text-xs">å°æ—¶æ¸¸æˆæ—¶é—´</span>
        </div>
      `,e.style.display="block";const r=s.getBoundingClientRect();e.style.top=`${r.top-e.offsetHeight-8+window.scrollY}px`,e.style.left=`${r.left+r.width/2-e.offsetWidth/2}px`}),s.addEventListener("mouseleave",()=>{e.style.display="none"})})}async function S(){const a=document.getElementById("steam-heatmap-grid"),e=document.getElementById("steam-heatmap-loading"),n=document.getElementById("steam-heatmap-empty"),s=document.getElementById("steam-heatmap-error"),l=document.getElementById("steam-heatmap-tooltip");if(a)try{const o=parseInt(a.dataset.days||"365",10),t=a.dataset.apiUrl||a.closest(".steam-heatmap-inline")?.querySelector("[data-api-url]")?.dataset.apiUrl;if(console.log("[Steam Debug] Init Heatmap:",{heatmapDays:o,apiUrl:t,gridElId:a.id}),a.querySelectorAll(".steam-heatmap-cell:not(.invisible)").length>0&&!t){console.log("[Steam Debug] Server-rendered heatmap detected, skipping API fetch"),e&&(e.style.display="none"),E(a,l);return}if(!t){console.log("[Steam Debug] No API URL and no server-rendered data, showing empty state"),e&&(e.style.display="none"),n&&(n.style.display="flex");return}const i=await x(t,o);if(console.log("[Steam Debug] Data Received:",i),e?(e.style.display="none",console.log("[Steam Debug] Loading element hidden")):console.warn("[Steam Debug] Loading element NOT FOUND!"),!i||!i.items||i.items.length===0){console.warn("[Steam Debug] No items in heatmap data"),n&&(n.style.display="flex");return}const d=new Map;i.items.forEach(r=>{d.set(r.spec.date,r.spec.playtimeMinutes||0)}),console.log("[Steam Debug] DateMap:",Object.fromEntries(d)),b(a,d,o,l),console.log("[Steam Debug] Heatmap rendered successfully")}catch(o){console.error("Failed to render heatmap:",o),e&&(e.style.display="none"),s&&(s.style.display="flex")}}async function x(a,e){const n=new Date,s=new Date;s.setDate(s.getDate()-e);const l=c=>{const i=c.getFullYear(),d=String(c.getMonth()+1).padStart(2,"0"),r=String(c.getDate()).padStart(2,"0");return`${i}-${d}-${r}`},o=new URL(a,window.location.origin);o.searchParams.set("startDate",l(s)),o.searchParams.set("endDate",l(n)),o.searchParams.set("page","1"),o.searchParams.set("size",e),console.log("[Steam Debug] Fetching URL:",o.toString());const t=await fetch(o.toString());if(!t.ok)throw console.error("[Steam Debug] Fetch Failed:",t.status),new Error("Failed to fetch heatmap data");return await t.json()}function b(a,e,n,s){const l=new Date,o=new Date;o.setDate(o.getDate()-n),a.innerHTML="";let t=new Date(o);const c=t.getDay();t.setDate(t.getDate()-c);const i=r=>{const p=r.getFullYear(),f=String(r.getMonth()+1).padStart(2,"0"),m=String(r.getDate()).padStart(2,"0");return`${p}-${f}-${m}`};let d=0;for(;t<=l;){const r=i(t),p=e.get(r)||0,f=(p/60).toFixed(1);let m=0;p>0&&(m=1),p>120&&(m=2),p>240&&(m=3);let u;m===0?u="color-mix(in oklch, var(--color-base-content) 10%, transparent)":m===1?u="color-mix(in oklch, var(--color-primary) 30%, transparent)":m===2?u="color-mix(in oklch, var(--color-primary) 60%, transparent)":u="var(--color-primary)";const g=document.createElement("div");g.className="steam-heatmap-cell",g.style.backgroundColor=u,g.dataset.date=r,g.dataset.hours=f,g.dataset.minutes=p,g.addEventListener("mouseenter",h=>{const y=new Date(r),v=`${y.getMonth()+1}æœˆ${y.getDate()}æ—¥`;s.innerHTML=`
        <div style="font-weight:600;margin-bottom:4px;">${v}</div>
        <div style="opacity:0.9;">${f} å°æ—¶</div>
      `;const D=a.closest(".steam-layout")?.getBoundingClientRect()||{left:0,top:0};s.style.display="block",s.style.left=h.clientX-D.left+10+"px",s.style.top=h.clientY-D.top-50+"px"}),g.addEventListener("mouseleave",()=>{s.style.display="none"}),a.appendChild(g),t.setDate(t.getDate()+1),d++}console.log("[Steam Debug] Rendered cells:",d)}
