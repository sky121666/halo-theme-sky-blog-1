const p="steam_page_cache";const D={get(e){try{const t=localStorage.getItem(`${p}_${e}`);if(!t)return null;const{value:s,expiry:a}=JSON.parse(t);return Date.now()>a?(localStorage.removeItem(`${p}_${e}`),null):s}catch{return null}},set(e,t){try{localStorage.setItem(`${p}_${e}`,JSON.stringify({value:t,expiry:Date.now()+18e4}))}catch{}}};async function u(e,t=!0){const s=e.replace(/[^a-z0-9]/gi,"_");if(t){const n=D.get(s);if(n)return n}const a=await fetch(`/apis/api.steam.halo.run/v1alpha1${e}`);if(!a.ok)throw new Error(`API error: ${a.status}`);const l=await a.json();return t&&D.set(s,l),l}document.addEventListener("alpine:init",()=>{Alpine._steamPageRegistered||(Alpine._steamPageRegistered=!0,Alpine.data("steamPage",()=>({profile:null,stats:null,badges:null,recentGames:[],games:{items:[],page:1,totalPages:1},error:null,_initialized:!1,loading:{profile:!0,stats:!0,badges:!0,recent:!0,games:!0},config:window.steamPageConfig||{},async init(){this._initialized||(this._initialized=!0,await Promise.all([this.loadProfile(),this.loadStats(),this.loadBadges(),this.loadRecent(),this.loadGames(1)]),this.$nextTick(()=>{$()}))},async loadProfile(){try{this.profile=await u("/profile")}catch(e){console.error("[Steam] profile åŠ è½½å¤±è´¥:",e),this.error="Steam èµ„æ–™åŠ è½½å¤±è´¥"}finally{this.loading.profile=!1}},async loadStats(){try{this.stats=await u("/stats")}catch(e){console.error("[Steam] stats åŠ è½½å¤±è´¥:",e)}finally{this.loading.stats=!1}},async loadBadges(){try{this.badges=await u("/badges")}catch(e){console.error("[Steam] badges åŠ è½½å¤±è´¥:",e)}finally{this.loading.badges=!1}},async loadRecent(){try{const e=this.config.recentGamesLimit||10,t=await u(`/recent?limit=${e}`);this.recentGames=Array.isArray(t)?t:[]}catch(e){console.error("[Steam] recent åŠ è½½å¤±è´¥:",e),this.recentGames=[]}finally{this.loading.recent=!1}},async loadGames(e=1){this.loading.games=!0;try{const t=this.config.gamesPageSize||20,s=await u(`/games?page=${e}&size=${t}`,!1);this.games=s||{items:[],page:1,totalPages:1}}catch(t){console.error("[Steam] games åŠ è½½å¤±è´¥:",t),this.games={items:[],page:1,totalPages:1}}finally{this.loading.games=!1}},getAchievementPercent(e){if(!e)return 0;const t=e.match(/(\d+)\s*\/\s*(\d+)/);if(t){const[,s,a]=t;return a>0?s/a*100:0}return 0}})))});document.addEventListener("DOMContentLoaded",()=>{b()});function b(){new MutationObserver(t=>{t.forEach(s=>{s.addedNodes.forEach(a=>{a.nodeType===1&&((a.querySelectorAll?.(".steam-game-img, .steam-badge-img, .steam-avatar-img")||[]).forEach(y),a.matches?.(".steam-game-img, .steam-badge-img, .steam-avatar-img")&&y(a))})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll(".steam-game-img, .steam-badge-img, .steam-avatar-img").forEach(y)}function y(e){e.dataset.handled||(e.dataset.handled="true",e.complete&&e.naturalHeight!==0?e.classList.add("loaded"):(e.addEventListener("load",function(){this.classList.add("loaded")}),e.addEventListener("error",function(){!this.src||this.src===window.location.href||this.src.endsWith("/steam")||(this.classList.add("loaded"),this.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 460 215"%3E%3Crect fill="%231b2838" width="460" height="215"/%3E%3Ctext x="50%25" y="50%25" fill="%2366c0f4" font-size="24" text-anchor="middle" dy=".3em"%3EğŸ®%3C/text%3E%3C/svg%3E')})))}async function $(){const e=document.getElementById("steam-heatmap-grid"),t=document.getElementById("steam-heatmap-loading"),s=document.getElementById("steam-heatmap-empty"),a=document.getElementById("steam-heatmap-error"),l=document.getElementById("steam-heatmap-tooltip");if(e)try{const n=parseInt(e.dataset.days||"365",10),r=e.dataset.apiUrl;if(!r){t&&(t.style.display="none"),s&&(s.style.display="flex");return}const c=await x(r,n);if(t&&(t.style.display="none"),!c||!c.items||c.items.length===0){s&&(s.style.display="flex");return}const g=new Map;c.items.forEach(i=>{const o=i.spec.date,h=i.spec.playtimeMinutes||0;g.set(o,(g.get(o)||0)+h)}),L(e,g,n,l)}catch(n){console.error("[Steam] çƒ­åŠ›å›¾åŠ è½½å¤±è´¥:",n),t&&(t.style.display="none"),a&&(a.style.display="flex")}}async function x(e,t){const s=new Date,a=new Date;a.setDate(a.getDate()-t);const l=c=>{const g=c.getFullYear(),i=String(c.getMonth()+1).padStart(2,"0"),o=String(c.getDate()).padStart(2,"0");return`${g}-${i}-${o}`},n=new URL(e,window.location.origin);n.searchParams.set("startDate",l(a)),n.searchParams.set("endDate",l(s)),n.searchParams.set("page","1"),n.searchParams.set("size",t);const r=await fetch(n.toString());if(!r.ok)throw new Error("Failed to fetch heatmap data");return await r.json()}function L(e,t,s,a){const l=new Date,n=new Date;n.setDate(n.getDate()-s),e.innerHTML="";let r=new Date(n);const c=r.getDay();r.setDate(r.getDate()-c);const g=i=>{const o=i.getFullYear(),h=String(i.getMonth()+1).padStart(2,"0"),d=String(i.getDate()).padStart(2,"0");return`${o}-${h}-${d}`};for(;r<=l;){const i=g(r),o=t.get(i)||0,h=(o/60).toFixed(1);let d=0;o>0&&(d=1),o>120&&(d=2),o>240&&(d=3);let f;d===0?f="color-mix(in oklch, var(--color-base-content) 10%, transparent)":d===1?f="color-mix(in oklch, var(--color-primary) 30%, transparent)":d===2?f="color-mix(in oklch, var(--color-primary) 60%, transparent)":f="var(--color-primary)";const m=document.createElement("div");m.className="steam-heatmap-cell",m.style.backgroundColor=f,m.dataset.date=i,m.dataset.hours=h,m.dataset.minutes=o,m.addEventListener("mouseenter",w=>{const v=new Date(i),S=`${v.getMonth()+1}æœˆ${v.getDate()}æ—¥`;a.innerHTML=`
        <div style="font-weight:600;margin-bottom:4px;">${S}</div>
        <div style="opacity:0.9;">${h} å°æ—¶</div>
      `;const E=e.closest(".steam-layout")?.getBoundingClientRect()||{left:0,top:0};a.style.display="block",a.style.left=w.clientX-E.left+10+"px",a.style.top=w.clientY-E.top-50+"px"}),m.addEventListener("mouseleave",()=>{a.style.display="none"}),e.appendChild(m),r.setDate(r.getDate()+1)}}
