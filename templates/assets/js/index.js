(function(){const m={info:(...e)=>{window.SYS_WEATHER_DEBUG&&console.log("[BG]",...e)},warn:(...e)=>console.warn("[BG]",...e)},E="sky_weather_cache_v13",C={sunBody:`<svg viewBox="0 0 200 200" class="w-full h-full fill-current text-yellow-400">
                <circle cx="100" cy="100" r="60" />
                <g class="sun-face" fill="#cc9900">
                  <circle cx="75" cy="90" r="8" />
                  <circle cx="125" cy="90" r="8" />
                  <path d="M70 120 Q100 145 130 120" stroke="#cc9900" stroke-width="6" fill="none" stroke-linecap="round" />
                  <ellipse cx="60" cy="105" rx="6" ry="3" fill="#ff7e7e" opacity="0.6" />
                  <ellipse cx="140" cy="105" rx="6" ry="3" fill="#ff7e7e" opacity="0.6" />
                </g>
              </svg>`,sunRays:`<svg viewBox="0 0 200 200" class="w-full h-full stroke-current text-yellow-400">
                <g stroke-width="12" stroke-linecap="round">
                  <path d="M100 20 L100 0 M100 180 L100 200 M20 100 L0 100 M180 100 L200 100 M43 43 L29 29 M157 157 L171 171 M43 157 L29 171 M157 43 L171 29" />
                </g>
              </svg>`,moon:`<svg viewBox="0 0 200 200" class="w-full h-full fill-current text-yellow-100">
             <path d="M100 15 A 85 85 0 1 1 100 185 A 65 65 0 1 0 100 15 Z" />
             <circle cx="80" cy="80" r="12" fill="rgba(0,0,0,0.1)" />
             <circle cx="120" cy="120" r="8" fill="rgba(0,0,0,0.1)" />
             <circle cx="90" cy="140" r="5" fill="rgba(0,0,0,0.1)" />
           </svg>`,cloud:`<svg viewBox="0 0 25 25" class="w-full h-full fill-current">
              <path d="M19.5,10 C19.5,6.96 17.04,4.5 14,4.5 C11.6,4.5 9.55,6.03 8.8,8.2 C8.54,8.13 8.27,8.1 8,8.1 C5.24,8.1 3,10.34 3,13.1 C3,15.86 5.24,18.1 8,18.1 L19.5,18.1 C21.98,18.1 24,16.08 24,14 C24,11.92 21.98,10 19.5,10 Z" />
            </svg>`};let p={type:"sunny",temp:20},M=null,r=null;function B(){if(m.info("init() 开始执行"),M=document.getElementById("weather-effect-root"),!M){m.warn("❌ weather-effect-root 元素不存在，背景类型可能未设为「天气联动」");return}if(m.info("✅ weather-effect-root 找到"),r=M.querySelector(".weather-effect-layer"),!r){m.warn("❌ .weather-effect-layer 不存在");return}m.info("✅ effectLayer 找到"),W(),m.info("初始渲染，currentState.type =",p.type),F(),ee(),window.addEventListener("sky-weather-updated",e=>{const t=e.detail?.weatherBg,a=e.detail?.rawData;if(m.info("收到 sky-weather-updated 事件，weatherBg =",t,"rawData =",a),!t)return;let n=t;t==="rain"&&(n="rainy"),t==="snow"&&(n="snowy"),t==="fog"&&(n="foggy"),m.info("切换背景 →",n),p.type=n,a&&k(a),F()}),m.info("事件监听器已注册，init() 完成")}function W(){m.info("loadWeatherData() 开始，读取 key:",E);try{const t=localStorage.getItem(E);if(m.info("localStorage 原始值:",t?"有数据":"无数据（null）"),t){const a=JSON.parse(t),n=a.weatherBg;if(m.info("缓存中的 weatherBg:",n,"| location:",a.location),n){let o=n;n==="rain"&&(o="rainy"),n==="snow"&&(o="snowy"),n==="fog"&&(o="foggy"),p.type=o,m.info("✅ 从缓存加载天气成功，type =",p.type),a.weather?k(a.weather):k({temp:20,humidity:50,wind:"0 km/h"});return}}}catch(t){m.warn("localStorage 读取失败:",t)}const e=new Date().getHours();p.type=e>=18||e<6?"night-clear":"sunny",k({temp:20,wind:"0 km/h"}),console.log("[BG] ⚠️ 无缓存，使用默认天气:",p.type)}function k(e){if(!M||!e)return;const t=M.querySelector(".weather-effect");if(!t)return;let a=parseFloat(e.temp);isNaN(a)&&(a=20),p.temp=a;let n=1;a<10&&(n=Math.max(.1,1-(10-a)*.1)),t.style.setProperty("--life-scale",n.toFixed(2));let o=0;if(typeof e.wind=="string"){const l=e.wind.match(/(\d+(\.\d+)?)/);l&&(o=parseFloat(l[1]))}else typeof e.wind_speed=="number"&&(o=e.wind_speed);let h=parseFloat(e.wind_direction)||0,s=Math.max(.1,o/10);s=Math.min(s,4);let i=h>180&&h<360?1:-1;o===0&&(i=-1);let c=s*i;p.windForce=s,p.windForceX=c,t.style.setProperty("--wind-force",s.toFixed(2)),t.style.setProperty("--wind-force-x",c.toFixed(2))}function F(){if(!r)return;r.lastElementChild&&typeof r.lastElementChild._cleanup=="function"&&r.lastElementChild._cleanup(),r.innerHTML="";const e=M.querySelector(".weather-effect");switch(e&&(e.className="weather-effect weather-"+p.type,e.style.setProperty("--wind-force",1)),O(),p.type){case"sunny":Y();break;case"cloudy":z(!1);break;case"night-clear":Z();break;case"night-cloudy":z(!0);break;case"foggy":J();break;case"rainy":K();break;case"snowy":j();break;case"stormy":Q();break}const t=document.createElement("div");t.className="bottom-fade",r.appendChild(t)}function O(){const e=document.createElement("div");e.className="atmosphere-glow",r.appendChild(e)}function Y(){S();const e=document.createElement("div");e.className="sun-container";const t=document.createElement("div");t.className="sun-rays",t.innerHTML=C.sunRays,e.appendChild(t);const a=document.createElement("div");a.className="sun-body",a.innerHTML=C.sunBody,e.appendChild(a);const n=document.createElement("div");n.className="sun-glow-outer",e.appendChild(n),r.appendChild(e);for(let o=0;o<15;o++)V()}function S(){const e=document.createElement("div");e.className="sunny-scene-container";const t=document.createElement("div");t.className="sunny-lawn",e.appendChild(t);for(let n=0;n<40;n++){const o=document.createElement("div");o.className="sunny-grass-blade",o.style.left=`${Math.random()*100}%`,o.style.height=`${15+Math.random()*25}px`,o.style.animationDelay=`${-Math.random()*4}s`,t.appendChild(o)}const a=["flower-type-tulip","flower-type-daisy","flower-type-sunflower"];for(let n=0;n<12;n++){const o=document.createElement("div"),h=a[Math.floor(Math.random()*a.length)];o.className=`sunny-flower-detailed ${h}`;const s=document.createElement("div");s.className="flower-head",o.appendChild(s),o.style.left=`${5+Math.random()*90}%`,o.style.height=`${40+Math.random()*40}px`,o.style.animationDelay=`${-Math.random()*5}s`,o.style.transform=`scale(${.7+Math.random()*.5})`,t.appendChild(o)}r.appendChild(e)}function V(){const e=document.createElement("div");e.className="bokeh-particle";const t=20+Math.random()*60;e.style.cssText=`
      width: ${t}px; height: ${t}px;
      left: ${Math.random()*100}%; top: ${Math.random()*80}%;
      opacity: ${.1+Math.random()*.2};
      animation-duration: ${15+Math.random()*20}s;
      animation-delay: ${-Math.random()*20}s;
    `,r.appendChild(e)}function z(e){e?(D(),H(30,!0),X(!0)):S();const t=e?5:8;for(let a=0;a<t;a++)I(e)}function I(e,t){const a=document.createElement("div");a.className="cloud-cartoon "+(e?"night":"day"),a.innerHTML=C.cloud;const n=.6+Math.random()*1.2,o=5+Math.random()*50,h=p.windForce||1,i=(60+(1.8-n)*40+Math.random()*30)/h,c=e?.3+Math.random()*.2:.85+Math.random()*.15,l=Math.random()*300;a.style.cssText=`
      top: ${o}%;
      left: 0;
      --cloud-scale: ${n};
      --cloud-start-offset: ${l}px;
      opacity: ${c};
      animation-duration: ${i}s;
      animation-delay: ${-Math.random()*i}s;
      z-index: ${20+Math.floor(n*10)};
      color: ${e?"#a0a4b8":"#ffffff"};
    `,r.appendChild(a)}function Z(){D(),H(50,!0),X(!1)}function D(){const e=document.createElement("div");e.className="night-scene-container",e.id="night-scene",["sm-1","sm-2"].forEach(s=>{const i=document.createElement("div");i.className=`spooky-mountain ${s}`,e.appendChild(i)});for(let s=0;s<6;s++){const i=document.createElement("div");i.className="spooky-tree";const c=180+Math.random()*100,l=c*.6;i.style.cssText=`
            left: ${-10+Math.random()*110}%; // 覆盖稍宽范围
            width: ${l}px;
            height: ${c}px;
            z-index: ${2+Math.random()*2};
            transform: scaleX(${Math.random()>.5?1:-1}); // 随机翻转
        `,e.appendChild(i)}r.appendChild(e);const n=setInterval(()=>{if(!document.getElementById("night-scene"))return;const s=document.createElement("div"),i=Math.random()>.7;s.className=`spooky-eye-pair ${i?"eyes-yellow":""}`,s.style.left=`${Math.random()*100}%`,s.style.bottom=`${20+Math.random()*100}px`,s.style.animationDelay=`${Math.random()*2}s`,e.appendChild(s),setTimeout(()=>s.remove(),4e3)},2e3),h=setInterval(()=>{if(!document.getElementById("night-scene"))return;const s=document.createElement("div");s.className="ghost-firefly",s.style.left=`${Math.random()*100}%`,s.style.bottom=`${Math.random()*50}%`,e.appendChild(s),setTimeout(()=>s.remove(),8e3)},1500);e._cleanup=()=>{clearInterval(n),clearInterval(h)}}function X(e){const t=document.createElement("div");t.className="moon-container",e&&t.classList.add("cloudy-moon");const a=document.createElement("div");a.className="moon-icon",a.innerHTML=C.moon,t.appendChild(a);const n=document.createElement("div");n.className="moon-glow",t.appendChild(n),r.appendChild(t)}function H(e,t=!1){for(let a=0;a<e;a++){const n=document.createElement("div");n.className="star",t&&n.classList.add("dim");const o=1+Math.random()*3;n.style.cssText=`
        width: ${o}px; height: ${o}px;
        left: ${Math.random()*100}%; top: ${Math.random()*60}%;
        animation-duration: ${2+Math.random()*3}s;
        animation-delay: ${-Math.random()*3}s;
      `,r.appendChild(n)}}function J(){const e=document.createElement("div");e.className="mist-scene-container",e.id="mist-scene";const t=document.createElement("div");t.className="mist-sun",e.appendChild(t),["m-1","m-2","m-3"].forEach(l=>{const f=document.createElement("div");f.className=`mist-mountain ${l}`,e.appendChild(f)}),["t-1","t-2","t-3","t-4"].forEach(l=>{const f=document.createElement("div");f.className=`mist-tree ${l}`,e.appendChild(f)});const o=["mist-layer-2","mist-layer-1","mist-layer-3"],h=[];o.forEach(l=>{const f=document.createElement("div");f.className=`mist-fog-layer ${l}`,e.appendChild(f),h.push(f)}),r.appendChild(e);const i=setInterval(()=>{if(!document.getElementById("mist-scene"))return;const l=document.createElement("div");l.className="mist-fog-puff";const f=Math.random()*180+60,y=Math.random()*35+55,w=Math.random()*10+12,g=(Math.random()-.5)*400;l.style.cssText=`
        width: ${f}px; height: ${f}px;
        top: ${y}%; left: ${Math.random()*100}%;
      `;const v=l.animate([{transform:"translate(0, 0) scale(0.5)",opacity:0},{opacity:.5,offset:.2},{opacity:.5,offset:.8},{transform:`translate(${g}px, -80px) scale(1.8)`,opacity:0}],{duration:w*1e3,easing:"linear",fill:"forwards"});e.appendChild(l),v.onfinish=()=>l.remove()},600),c=l=>{const f=l.clientX/window.innerWidth;h[1]&&(h[1].style.transform=`translateX(${-f*50}px)`),h[0]&&(h[0].style.transform=`translateX(${f*20}px) scaleX(-1)`),h[2]&&(h[2].style.transform=`translateX(${-f*90}px)`)};document.addEventListener("mousemove",c),e._cleanup=()=>{clearInterval(i),document.removeEventListener("mousemove",c)}}function K(){P(!1)}function Q(){P(!0)}function P(e){for(let d=0;d<(e?8:5);d++)I(!0);const t=window.innerWidth,a=e?t/10:t/25,n=Math.min(e?150:60,Math.max(20,Math.floor(a))),o=p.windForce||1,h=p.windForceX||-1,s=e?{count:n,speedBase:14*Math.max(1,o*.8),wind:6*h,thickness:3,color:"rgba(130, 180, 255, 0.8)"}:{count:n,speedBase:8*Math.max(1,Math.sqrt(o)),wind:2*h,thickness:2,color:"rgba(174, 217, 255, 0.6)"},i=document.createElement("canvas");i.className="rain-canvas",i.id="rain-canvas",r.appendChild(i);const c=document.createElement("canvas");c.className="lightning-canvas",c.id="lightning-canvas",r.appendChild(c);const l=document.createElement("div");l.className="flash-overlay",l.id="flash-overlay",r.appendChild(l);const f=document.createElement("div");f.className="rain-ground-props",U(f),r.appendChild(f);const y=i.getContext("2d"),w=c.getContext("2d");let g,v,N=[],$=[],_=null,T=0;function q(){g=i.width=c.width=r.offsetWidth||window.innerWidth,v=i.height=c.height=r.offsetHeight||window.innerHeight,N.forEach(d=>{d.x>g&&(d.x=Math.random()*g)})}q();let R;const A=()=>{clearTimeout(R),R=setTimeout(()=>{q()},200)};window.addEventListener("resize",A);class te{constructor(u=!1){this.x=Math.random()*g,this.y=u?Math.random()*v:-50,this.z=Math.random(),this.speed=s.speedBase*(1+this.z)+Math.random()*2,this.len=10+this.z*15,this.thick=s.thickness*(.5+this.z*.5),this.vx=s.wind*(1+(1-this.z))}update(){this.x+=this.vx,this.y+=this.speed,this.y>v-40&&(Math.random()>.85&&$.push(new ne(this.x,v-40)),this.reset()),this.x<0&&(this.x=g),this.x>g&&(this.x=0)}reset(){this.x=Math.random()*g,this.y=-50,this.z=Math.random(),this.speed=s.speedBase*(1+this.z)+Math.random()*2}draw(){y.beginPath(),y.moveTo(this.x,this.y),y.lineTo(this.x-this.vx*2,this.y-this.len),y.strokeStyle=s.color,y.lineWidth=this.thick,y.lineCap="round",y.stroke()}}class ne{constructor(u,x){this.x=u,this.y=x,this.life=8,this.particles=[];for(let b=0;b<3;b++)this.particles.push({vx:(Math.random()-.5)*4,vy:-Math.random()*3,px:0,py:0})}update(){this.life--,this.particles.forEach(u=>{u.px+=u.vx,u.py+=u.vy,u.vy+=.3})}draw(){const u=this.life/8;y.fillStyle=`rgba(200, 230, 255, ${u})`,this.particles.forEach(x=>{y.beginPath(),y.arc(this.x+x.px,this.y+x.py,2,0,Math.PI*2),y.fill()})}}for(let d=0;d<s.count;d++)N.push(new te(!0));function ae(){w.clearRect(0,0,g,v),w.beginPath();let u=g*.2+Math.random()*g*.6,x=0;for(w.moveTo(u,x);x<v*.7;){const b=(Math.random()-.5)*80,se=20+Math.random()*40;u+=b,x+=se,w.lineTo(u,x)}w.strokeStyle="#fff",w.shadowBlur=25,w.shadowColor="#f1c40f",w.lineWidth=3,w.stroke(),w.shadowBlur=0,setTimeout(()=>w.clearRect(0,0,g,v),120)}function oe(){const d=p.windForce>2;l.style.opacity=d?"0.9":"0.6",setTimeout(()=>{l.style.opacity="0"},80),setTimeout(()=>{l.style.opacity=d?"0.4":"0.2"},120),setTimeout(()=>{l.style.opacity="0"},200),d&&(M.classList.add("weather-shake"),setTimeout(()=>M.classList.remove("weather-shake"),400)),ae()}function G(){if(document.getElementById("rain-canvas")){y.clearRect(0,0,g,v),N.forEach(d=>{d.update(),d.draw()});for(let d=$.length-1;d>=0;d--)$[d].update(),$[d].draw(),$[d].life<=0&&$.splice(d,1);if(e){const d=Date.now();if(d>T){oe();const u=Math.max(800,2e3-(p.windForce-1)*400);T=d+u+Math.random()*3e3}}_=requestAnimationFrame(G)}}T=Date.now()+1e3,G();const L=document.createElement("div");L.id="rain-system",L.style.display="none",L._cleanup=()=>{cancelAnimationFrame(_),window.removeEventListener("resize",A)},r.appendChild(L)}function U(e){const t=document.createElement("div");t.className="rain-meadow-container",["rm-hill-2","rm-hill-1","rm-hill-3"].forEach(s=>{const i=document.createElement("div");i.className=`rain-meadow-hill ${s}`,t.appendChild(i)}),e.appendChild(t);const a=document.createElement("div");a.className="rain-puddle",a.style.cssText="width: 80px; height: 25px; left: 25%; bottom: 15px;",e.appendChild(a);const n=document.createElement("div");n.className="flat-rain-path",e.appendChild(n);const o=document.createElement("div");o.className="flat-rain-house",o.innerHTML=`
          <div class="house-chimney"></div>
          <div class="house-window"></div>
      `,e.appendChild(o);const h=document.createElement("div");h.className="flat-rain-lamp",h.innerHTML=`
          <div class="lamp-head"></div>
          <div class="lamp-light"></div> 
      `,e.appendChild(h)}function j(){const e=document.createElement("div");e.className="snow-scene-container",["sh-1","sh-2"].forEach(i=>{const c=document.createElement("div");c.className=`snow-hill ${i}`,e.appendChild(c)});const a=document.createElement("div");a.className="snow-ground",e.appendChild(a);const n=document.createElement("div");n.className="snow-igloo";const o=document.createElement("div");o.className="snow-igloo-entrance",n.appendChild(o),e.appendChild(n),["sp-1","sp-2","sp-3"].forEach(i=>{const c=document.createElement("div");c.className=`snow-pine ${i}`,e.appendChild(c)}),r.appendChild(e);const s=document.createElement("div");s.className="snow-container";for(let i=0;i<80;i++){const c=document.createElement("div");c.className="snow-flake-svg";const l=Math.random()<.3,f=l?12+Math.random()*10:4+Math.random()*8,y=p.windForce||1,w=p.windForceX||-1,v=(l?6+Math.random()*4:3+Math.random()*5)/Math.max(.5,Math.sqrt(y));Math.random()>.4?c.innerHTML='<svg viewBox="0 0 24 24" class="w-full h-full fill-current"><circle cx="12" cy="12" r="8"/></svg>':c.innerHTML='<svg viewBox="0 0 24 24" class="w-full h-full stroke-current" stroke-width="2"><path d="M12 2v20M2 12h20M4.93 4.93l14.14 14.14M4.93 19.07L19.07 4.93"/></svg>';const N=-20*w;c.style.cssText=`
        left: ${Math.random()*100}%;
        width: ${f}px; height: ${f}px;
        opacity: ${l?.95:.6+Math.random()*.3};
        --wind-offset: ${N}px;
        animation-duration: ${v}s;
        animation-delay: ${-Math.random()*v}s;
      `,s.appendChild(c)}r.appendChild(s)}function ee(){const e=M.querySelector(".scroll-mask");if(!e)return;let t=!1;window.addEventListener("scroll",()=>{t||(requestAnimationFrame(()=>{e.style.opacity=window.scrollY>50?"0.3":"0",t=!1}),t=!0)},{passive:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{B()}):B()})();window.handleMomentCardGlow=function(m,E){const C=E.querySelector(".moment-glow");if(!C)return;const p=E.getBoundingClientRect(),M=m.clientX-p.left,r=m.clientY-p.top;C.style.left=M+"px",C.style.top=r+"px"};window.showMomentCardGlow=function(m){const E=m.querySelector(".moment-glow");E&&(E.style.opacity="1")};window.hideMomentCardGlow=function(m){const E=m.querySelector(".moment-glow");E&&(E.style.opacity="0")};(function(){const m={titleElement:null,decorationEffect:"none",styleEffect:"none",originalText:"",init(){this.titleElement=document.getElementById("main-title"),this.titleElement&&(this.decorationEffect=this.titleElement.dataset.decorationEffect||"none",this.styleEffect=this.titleElement.dataset.styleEffect||"none",this.originalText=this.titleElement.dataset.originalText||this.titleElement.textContent.trim(),this.applyEffects())},applyEffects(){this.applyDecorationEffect(),this.applyStyleEffect()},applyDecorationEffect(){this.decorationEffect!=="none"&&((this.decorationEffect==="effect-particles"||this.decorationEffect==="effect-starlight")&&(this.titleElement.innerHTML=`<span><span><span>${this.originalText}</span></span></span>`),this.titleElement.classList.add(this.decorationEffect),this.decorationEffect==="effect-neon-edge"&&this.titleElement.setAttribute("data-text",this.originalText))},applyStyleEffect(){this.styleEffect!=="none"&&(this.titleElement.classList.add(this.styleEffect),(this.styleEffect==="effect-marker-pop"||this.styleEffect==="effect-diagonal-split")&&this.titleElement.setAttribute("data-text",this.originalText))}};document.addEventListener("DOMContentLoaded",()=>{m.init()})})();
