document.addEventListener("alpine:init",()=>{Alpine.data("categoriesPage",()=>({activeSlug:"all",activeName:"全部",isLoading:!1,isSwitching:!1,items:[],nextUrl:"",observer:null,init(){const t=document.getElementById("initial-next-url");this.nextUrl=t?.value||"";const e=Array.from(document.querySelectorAll("#category-posts article"));this.items=e.map(t=>{const e=t.querySelector("h3"),r=t.querySelector("a");return t.querySelector("span"),{spec:{title:e?.textContent?.trim()||""},status:{permalink:r?.getAttribute("href")||"#"},stats:{},metadata:{name:r?.getAttribute("href")||""}}});const r=new CustomEvent("category-items",{detail:this.items});document.dispatchEvent(r),this.enableInfiniteScroll()},enableInfiniteScroll(){const t=document.getElementById("infinite-sentinel");t&&(this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&this.loadMore()})},{root:null,rootMargin:"0px 0px 200px 0px",threshold:0}),this.observer.observe(t))},async switchCategory(t){if(this.activeSlug===t&&!this.isSwitching)return;this.isSwitching=!0,this.isLoading=!0,this.activeSlug=t,this.activeName="all"===t?"全部":this.findNameBySlug(t);const e="all"===t?"/categories":`/categories/${encodeURIComponent(t)}`;try{performance.now();const t=await this.fetchPage(e),{listHtml:r,nextUrl:n}=this.extractList(t);this.renderList(r),this.nextUrl=n||"";performance.now()}catch(r){console.warn("切换分类失败：",r)}finally{this.isLoading=!1,setTimeout(()=>{this.isSwitching=!1},200)}},async loadMore(){if(this.nextUrl&&!this.isLoading){this.isLoading=!0;try{const t=await this.fetchPage(this.nextUrl),{itemsHtml:e,nextUrl:r}=this.extractItems(t);this.appendItems(e),this.nextUrl=r||""}catch(t){console.warn("加载更多失败：",t)}finally{this.isLoading=!1}}},findNameBySlug(t){const e=document.querySelector(`button[data-slug="${CSS.escape(t)}"] span.font-medium`);return e?.textContent?.trim()||t},async fetchPage(t){const e=await fetch(t,{headers:{"X-Requested-With":"fetch"}});return await e.text()},extractList(t){const e=(new DOMParser).parseFromString(t,"text/html"),r=e.querySelector("#category-posts"),n=e.querySelector("#initial-next-url");return{listHtml:r?.innerHTML||"",nextUrl:n?.getAttribute("value")||""}},extractItems(t){const e=(new DOMParser).parseFromString(t,"text/html"),r=e.querySelector("#category-posts"),n=e.querySelector("#initial-next-url");return{itemsHtml:r?Array.from(r.children).map(t=>t.outerHTML).join(""):"",nextUrl:n?.getAttribute("value")||""}},renderList(t){const e=document.getElementById("category-posts");if(!e)return;e.innerHTML=t||"";const r=Array.from(e.querySelectorAll("article"));this.items=r.map(t=>{const e=t.querySelector("h3"),r=t.querySelector("a");return{spec:{title:e?.textContent?.trim()||""},status:{permalink:r?.getAttribute("href")||"#"},stats:{},metadata:{name:r?.getAttribute("href")||""}}});const n=new CustomEvent("category-items",{detail:this.items});document.dispatchEvent(n)},appendItems(t){const e=document.getElementById("category-posts");if(!e||!t)return;const r=document.createRange().createContextualFragment(t);e.appendChild(r)}})),Alpine.data("categoryArchive",()=>({nextUrl:"",isLoading:!1,observer:null,init(){const t=document.getElementById("initial-next-url");this.nextUrl=t?.value||"",this.enableInfiniteScroll();const e=Array.from(document.querySelectorAll("#category-posts article")).map(t=>{const e=t.querySelector("h3"),r=t.querySelector("a");return t.querySelector("span"),{spec:{title:e?.textContent?.trim()||""},status:{permalink:r?.getAttribute("href")||"#"},stats:{},metadata:{name:r?.getAttribute("href")||""}}}),r=new CustomEvent("category-items",{detail:e});document.dispatchEvent(r)},enableInfiniteScroll(){const t=document.getElementById("infinite-sentinel");t&&(this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting&&this.loadMore()})},{root:null,rootMargin:"0px 0px 200px 0px",threshold:0}),this.observer.observe(t))},async loadMore(){if(this.nextUrl&&!this.isLoading){this.isLoading=!0;try{const t=await fetch(this.nextUrl,{headers:{"X-Requested-With":"fetch"}}),e=await t.text(),r=(new DOMParser).parseFromString(e,"text/html"),n=r.querySelector("#category-posts"),i=r.querySelector("#initial-next-url"),s=n?Array.from(n.children).map(t=>t.outerHTML).join(""):"",a=document.getElementById("category-posts");a&&s&&a.appendChild(document.createRange().createContextualFragment(s)),this.nextUrl=i?.getAttribute("value")||""}catch(t){console.warn("归档页加载更多失败：",t)}finally{this.isLoading=!1}}}}))});
