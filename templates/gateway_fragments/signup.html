<!-- ========================================== -->
<!--    Gateway Fragments - Signup             -->
<!--    注册表单片段 (Premium Style)           -->
<!-- ========================================== -->

<form th:fragment="form" class="space-y-5" name="signup-form" id="signup-form" th:action="@{/signup}"
    th:object="${form}" method="post">
    <!-- 错误提示 -->
    <div class="p-4 rounded-xl bg-error/10 border border-error/20 text-error text-sm flex items-start gap-3"
        role="alert" th:if="${error == 'invalid-email-code'}">
        <span class="icon-[heroicons--exclamation-circle] w-5 h-5 shrink-0 mt-0.5"></span>
        <span>邮箱验证码无效或已过期</span>
    </div>
    <div class="p-4 rounded-xl bg-error/10 border border-error/20 text-error text-sm flex items-start gap-3"
        role="alert" th:if="${error == 'rate-limit-exceeded'}">
        <span class="icon-[heroicons--exclamation-circle] w-5 h-5 shrink-0 mt-0.5"></span>
        <span>请求过于频繁，请稍后再试</span>
    </div>
    <div class="p-4 rounded-xl bg-error/10 border border-error/20 text-error text-sm flex items-start gap-3"
        role="alert" th:if="${error == 'duplicate-username'}">
        <span class="icon-[heroicons--exclamation-circle] w-5 h-5 shrink-0 mt-0.5"></span>
        <span>该用户名已被使用</span>
    </div>
    <div class="p-4 rounded-xl bg-error/10 border border-error/20 text-error text-sm flex items-start gap-3"
        role="alert" th:if="${error == 'restricted-username'}">
        <span class="icon-[heroicons--exclamation-circle] w-5 h-5 shrink-0 mt-0.5"></span>
        <span>该用户名不可用</span>
    </div>

    <!-- 用户名 + 显示名称 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="space-y-2">
            <label for="username" class="block text-sm font-medium text-base-content/70">用户名</label>
            <input type="text" id="username" name="username" placeholder="4-63 个字符" autocomplete="off"
                spellcheck="false" autocorrect="off" autocapitalize="off" autofocus required minlength="4"
                maxlength="63" th:field="*{username}" class="premium-input" />
            <p class="text-xs text-error" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></p>
        </div>

        <div class="space-y-2">
            <label for="displayName" class="block text-sm font-medium text-base-content/70">显示名称</label>
            <input type="text" id="displayName" name="displayName" placeholder="您的昵称" autocomplete="off"
                spellcheck="false" autocorrect="off" autocapitalize="off" required th:field="*{displayName}"
                class="premium-input" />
            <p class="text-xs text-error" th:if="${#fields.hasErrors('displayName')}" th:errors="*{displayName}"></p>
        </div>
    </div>

    <!-- 邮箱 + 验证码 -->
    <div class="grid grid-cols-1 gap-4"
        th:classappend="${globalInfo.mustVerifyEmailOnRegistration ? 'sm:grid-cols-2' : ''}">
        <div class="space-y-2">
            <label for="email" class="block text-sm font-medium text-base-content/70">邮箱地址</label>
            <input type="email" id="email" name="email" placeholder="example@email.com" autocomplete="off"
                spellcheck="false" autocorrect="off" autocapitalize="off" required th:field="*{email}"
                class="premium-input" />
            <p class="text-xs text-error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></p>
        </div>

        <div class="space-y-2" th:if="${globalInfo.mustVerifyEmailOnRegistration}">
            <label for="emailCode" class="block text-sm font-medium text-base-content/70">验证码</label>
            <div class="flex gap-2">
                <input type="text" inputmode="numeric" pattern="\d*" id="emailCode" name="emailCode" placeholder="6 位数字"
                    required class="premium-input flex-1" />
                <button id="emailCodeSendButton" type="button"
                    class="px-4 py-2 rounded-xl bg-base-200 text-base-content/70 hover:bg-base-300 transition-colors font-medium text-sm whitespace-nowrap">
                    发送验证码
                </button>
            </div>
            <p class="text-xs text-error" th:if="${#fields.hasErrors('emailCode')}" th:errors="*{emailCode}"></p>
        </div>
    </div>

    <!-- 密码 -->
    <div class="space-y-2">
        <label for="password" class="block text-sm font-medium text-base-content/70">密码</label>
        <div class="relative toggle-password-display-flag">
            <input id="password" name="password" type="password" placeholder="至少 5 个字符" autocomplete="off" required
                minlength="5" maxlength="257" class="premium-input pr-12" />
            <div
                class="absolute right-4 top-1/2 -translate-y-1/2 toggle-password-button cursor-pointer text-base-content/40 hover:text-base-content transition-colors">
                <svg class="password-hidden-icon w-5 h-5" style="display: none" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z">
                    </path>
                </svg>
                <svg class="password-display-icon w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M17.883 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.818-9A10.982 10.982 0 0 1 4.52 5.935L1.394 2.808l1.414-1.414l19.799 19.798l-1.414 1.415l-3.31-3.31ZM5.936 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.936 7.35Zm6.978 6.978l-3.242-3.241a2.5 2.5 0 0 0 3.241 3.241Zm7.893 2.265l-1.431-1.431A8.935 8.935 0 0 0 20.778 12A9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.593Zm-9.084-9.084a4.5 4.5 0 0 1 4.769 4.769l-4.77-4.77Z">
                    </path>
                </svg>
            </div>
        </div>
        <p class="text-xs text-error" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></p>
    </div>

    <!-- 确认密码 -->
    <div class="space-y-2">
        <label for="confirmPassword" class="block text-sm font-medium text-base-content/70">确认密码</label>
        <div class="relative toggle-password-display-flag">
            <input id="confirmPassword" name="confirmPassword" type="password" placeholder="再次输入密码" autocomplete="off"
                required minlength="5" maxlength="257" class="premium-input pr-12" />
            <div
                class="absolute right-4 top-1/2 -translate-y-1/2 toggle-password-button cursor-pointer text-base-content/40 hover:text-base-content transition-colors">
                <svg class="password-hidden-icon w-5 h-5" style="display: none" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z">
                    </path>
                </svg>
                <svg class="password-display-icon w-5 h-5" viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M17.883 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.818-9A10.982 10.982 0 0 1 4.52 5.935L1.394 2.808l1.414-1.414l19.799 19.798l-1.414 1.415l-3.31-3.31ZM5.936 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.936 7.35Zm6.978 6.978l-3.242-3.241a2.5 2.5 0 0 0 3.241 3.241Zm7.893 2.265l-1.431-1.431A8.935 8.935 0 0 0 20.778 12A9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.593Zm-9.084-9.084a4.5 4.5 0 0 1 4.769 4.769l-4.77-4.77Z">
                    </path>
                </svg>
            </div>
        </div>
        <p class="text-xs text-error" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}">
        </p>
    </div>

    <!-- Altcha 验证码 -->
    <div halo:captcha class="w-full"></div>

    <!-- 提交按钮 -->
    <div class="pt-2">
        <button type="submit" class="premium-btn">
            创建账户
        </button>
    </div>

    <!-- 密码确认脚本 -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            setupPasswordConfirmation("password", "confirmPassword");
        });
    </script>

    <!-- 邮箱验证码发送脚本 -->
    <script th:if="${globalInfo.mustVerifyEmailOnRegistration}" th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            const headerName = /*[[${_csrf.headerName}]]*/ "";
            const token = /*[[${_csrf.token}]]*/ "";

            async function sendRequest() {
                const email = document.getElementById("email").value;
                if (!email) {
                    throw new Error("请先输入邮箱地址");
                }

                // 检查是否启用 Altcha，如果启用则获取验证结果
                const altchaEnabled = [[${#strings.equalsIgnoreCase(globalInfo.captchaProvider, 'ALTCHA')}]];
                const altchaPayload = altchaEnabled && typeof requestAltchaChallengeResult === 'function' 
                    ? await requestAltchaChallengeResult() 
                    : '';

                const response = await fetch("/signup/send-email-code", {
                    method: "POST",
                    body: JSON.stringify({ email: email }),
                    headers: {
                        "Content-Type": "application/json",
                        [headerName]: token,
                        'X-Altcha-Payload': altchaPayload,
                    },
                });

                if (!response.ok) {
                    const json = await response.json();
                    if (json.errors && json.errors.length) {
                        throw new Error(json.errors[0]);
                    }
                }
                return response;
            }

            const emailCodeSendButton = document.getElementById("emailCodeSendButton");
            sendVerificationCode(emailCodeSendButton, sendRequest);
        });
    </script>
</form>