<!-- 首页内容区 -->
<th:block th:fragment="main-content"
  th:with="githubUsername = ${theme.config.about_settings.github.username},
                   profile = ${theme.config.about_settings.profile},
                   contentSettings = ${theme.config.index.content_settings},
                   postSettings = ${theme.config.index.post_settings},
                   friendsSettings = ${theme.config.index.friends_settings},
                   hasFriendsPlugin = ${pluginFinder.available('plugin-friends')},
                   showFriendsTab = ${hasFriendsPlugin and friendsSettings.show_friends_tab != false},
                   showSidebar = ${contentSettings.show_sidebar != false},
                   showHeatmap = ${contentSettings.show_heatmap != false},
                   heatmapType = ${contentSettings.heatmap_type ?: 'github'},
                   tabStyle = ${contentSettings.tab_style ?: 'chips'},
                   listStyle = ${postSettings.list_style ?: 'magazine'},
                   postCount = ${postSettings.post_count ?: 8},
                   friendsCount = ${friendsSettings.friends_count ?: 10},
                   friendsListStyle = ${friendsSettings.list_style ?: 'two_columns'},
                   globalSidebarCfg = ${theme.config.general.sidebar_settings},
                   useCustomSidebar = ${contentSettings.enable_custom_sidebar == true},
                   sidebarPosition = ${useCustomSidebar ? (contentSettings.sidebar_position ?: 'right') : (globalSidebarCfg?.position ?: 'right')}">

  <div
    th:class="${theme.config.index.header_settings?.enable_header != false} ? 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20 pb-8 lg:pt-24 lg:pb-12' : 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6 pb-8 lg:pt-8 lg:pb-12'">

    <!-- 主内容区：内容 + 侧边栏 -->
    <div class="flex gap-8 lazy-anim" th:classappend="${sidebarPosition == 'left'} ? 'flex-row-reverse' : ''">
      <!-- 左侧：热力图 + Tab切换 + 文章列表 -->
      <section class="flex-1 min-w-0">
        <!-- GitHub 热力图 -->
        <div th:if="${showHeatmap and heatmapType == 'github' and githubUsername != null and !githubUsername.isEmpty()}"
          class="heatmap-card rounded-[1.5rem] backdrop-blur-xl bg-base-100/70 border border-base-content/5 shadow-lg p-5 mb-8"
          x-data="githubHeatmap()" x-init="init()" x-cloak>

          <!-- 骨架屏加载状态 -->
          <div x-show="loading" class="heatmap-skeleton">
            <div class="flex flex-wrap gap-[3px]">
              <template x-for="i in 371" :key="i">
                <div class="heatmap-skeleton-cell" :style="'animation-delay: ' + (i * 2) + 'ms'"></div>
              </template>
            </div>
          </div>

          <!-- 热力图图片 -->
          <img x-show="!loading && !error" x-ref="img" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" class="github-heatmap-img"
            alt="GitHub Contributions" />

          <!-- 错误状态 -->
          <div x-show="error" x-cloak class="heatmap-error">
            <span class="icon-[heroicons--exclamation-triangle] heatmap-error-icon"></span>
            <p class="heatmap-error-text">GitHub 热力图加载失败</p>
            <button @click="retry()" class="heatmap-retry-btn">
              <span class="icon-[heroicons--arrow-path] w-3 h-3 mr-1 inline-block"></span>
              重试
            </button>
          </div>

          <!-- 底部信息栏 -->
          <div x-show="!loading && !error" class="heatmap-footer flex items-center justify-between mt-3">
            <span class="text-xs text-base-content/40">GitHub 年度贡献</span>
            <div class="heatmap-legend hidden sm:flex items-center gap-1 text-xs text-base-content/40">
              <span>Less</span>
              <span
                class="inline-block w-2.5 h-2.5 rounded-sm border border-base-content/10 bg-base-content/[0.03]"></span>
              <span class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/25"></span>
              <span class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/50"></span>
              <span class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/75"></span>
              <span x-ref="colorProbe" class="inline-block w-2.5 h-2.5 rounded-sm bg-primary"></span>
              <span>More</span>
            </div>
          </div>
        </div>

        <script th:inline="javascript">
          document.addEventListener('alpine:init', () => {
            Alpine.data('githubHeatmap', () => ({
              loading: true,
              error: false,
              username: /*[[${githubUsername}]]*/ '',
              _initialized: false,

              init() {
                if (this._initialized) return;
                this._initialized = true;

                if (!this.username) {
                  this.loading = false;
                  this.error = true;
                  return;
                }

                this.$nextTick(() => this.loadImage());

                new MutationObserver(() => {
                  requestAnimationFrame(() => this.updateImageSrc());
                }).observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
              },

              getPrimaryHex() {
                const probe = this.$refs.colorProbe;
                if (!probe) return '6366f1';
                const color = getComputedStyle(probe).backgroundColor;
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = 1;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, 1, 1);
                const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                return [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
              },

              getImageUrl() {
                return `https://ghchart.rshah.org/${this.getPrimaryHex()}/${this.username}`;
              },

              loadImage() {
                this.loading = true;
                this.error = false;

                const imgEl = this.$refs.img;
                if (!imgEl) {
                  this.loading = false;
                  this.error = true;
                  return;
                }

                const url = this.getImageUrl();
                const preloader = new Image();

                preloader.onload = () => {
                  imgEl.src = url;
                  this.loading = false;
                  this.error = false;
                };

                preloader.onerror = () => {
                  this.loading = false;
                  this.error = true;
                };

                preloader.src = url;
              },

              updateImageSrc() {
                const img = this.$refs.img;
                if (img && !this.error) {
                  img.src = this.getImageUrl();
                }
              },

              retry() {
                this.loadImage();
              }
            }));
          });
        </script>


        <!-- 文章热力图 -->
        <th:block th:if="${showHeatmap and heatmapType == 'article'}">
          <!-- 获取最近的文章用于统计 -->
          <th:block th:with="recentPosts = ${postFinder.list({page: 1, size: 500})}">
            <div
              class="heatmap-card rounded-[1.5rem] backdrop-blur-xl bg-base-100/70 border border-base-content/5 shadow-lg p-5 mb-8"
              x-data="articleHeatmap()" x-init="init()" x-cloak>

              <!-- 热力图容器 -->
              <div x-ref="container" class="w-full overflow-x-auto"></div>

              <!-- 空态提示 -->
              <div x-show="isEmpty" x-cloak class="heatmap-empty">
                <span class="icon-[heroicons--document-text] heatmap-empty-icon"></span>
                <p class="heatmap-empty-text">暂无文章发布记录</p>
              </div>

              <!-- 底部信息栏 -->
              <div x-show="!isEmpty" class="heatmap-footer flex items-center justify-between mt-3">
                <span class="text-xs text-base-content/40">文章年度发布 · <span x-text="totalCount"></span> 篇</span>
                <div class="heatmap-legend hidden sm:flex items-center gap-1 text-xs text-base-content/40">
                  <span>Less</span>
                  <span x-ref="level0"
                    class="inline-block w-2.5 h-2.5 rounded-sm border border-base-content/10 bg-base-content/[0.03]"></span>
                  <span x-ref="level1" class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/25"></span>
                  <span x-ref="level2" class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/50"></span>
                  <span x-ref="level3" class="inline-block w-2.5 h-2.5 rounded-sm bg-primary/75"></span>
                  <span x-ref="level4" class="inline-block w-2.5 h-2.5 rounded-sm bg-primary"></span>
                  <span>More</span>
                </div>
              </div>

              <!-- 存储文章数据 - 仅统计公开文章 -->
              <div x-ref="postsData" style="display:none;">
                <th:block th:each="post : ${recentPosts.items}">
                  <span
                    th:if="${post.spec.publishTime != null and (post.spec.visible == null or post.spec.visible.name() == 'PUBLIC')}"
                    th:data-date="${#dates.format(post.spec.publishTime, 'yyyy-MM-dd')}"
                    th:data-title="${post.spec.title}" th:data-slug="${post.spec.slug}"></span>
                </th:block>
              </div>
            </div>

            <!-- 自定义 Tooltip -->
            <div x-ref="tooltip" class="heatmap-tooltip" style="display:none;"></div>

            <script>
              document.addEventListener('alpine:init', () => {
                Alpine.data('articleHeatmap', () => ({
                  totalCount: 0,
                  isEmpty: false,
                  data: new Map(),
                  postsByDate: new Map(),
                  months: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                  weekdays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                  _initialized: false,

                  init() {
                    // 防止重复初始化
                    if (this._initialized) return;
                    this._initialized = true;

                    this.parseData();
                    this.isEmpty = this.totalCount === 0;

                    if (!this.isEmpty) {
                      this.$nextTick(() => {
                        this.render();
                        this.setupResizeObserver();
                        this.setupThemeObserver();
                      });
                    }
                  },

                  parseData() {
                    const container = this.$refs.postsData;
                    if (!container) return;

                    // 防止重复初始化 - 重置所有状态
                    this.totalCount = 0;
                    this.data = new Map();
                    this.postsByDate = new Map();

                    const oneYearAgo = new Date();
                    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                    const oneYearAgoStr = oneYearAgo.toISOString().split('T')[0];

                    // 使用 slug 去重，防止同一篇文章被多次统计
                    const seenSlugs = new Set();

                    container.querySelectorAll('span[data-date]').forEach(span => {
                      const date = span.getAttribute('data-date');
                      const title = span.getAttribute('data-title') || '';
                      const slug = span.getAttribute('data-slug') || '';

                      // 跳过一年前的文章
                      if (!date || date < oneYearAgoStr) return;

                      // 跳过已经统计过的文章（按 slug 去重）
                      if (seenSlugs.has(slug)) return;
                      seenSlugs.add(slug);

                      this.data.set(date, (this.data.get(date) || 0) + 1);

                      if (!this.postsByDate.has(date)) {
                        this.postsByDate.set(date, []);
                      }
                      this.postsByDate.get(date).push({ title, slug });

                      this.totalCount++;
                    });
                  },

                  getColors() {
                    const colorToRgba = (el) => {
                      if (!el) return 'rgba(128,128,128,0.1)';
                      const color = getComputedStyle(el).backgroundColor;
                      const canvas = document.createElement('canvas');
                      canvas.width = canvas.height = 1;
                      const ctx = canvas.getContext('2d');
                      ctx.fillStyle = color;
                      ctx.fillRect(0, 0, 1, 1);
                      const [r, g, b, a] = ctx.getImageData(0, 0, 1, 1).data;
                      return `rgba(${r}, ${g}, ${b}, ${a / 255})`;
                    };

                    return {
                      0: colorToRgba(this.$refs.level0),
                      1: colorToRgba(this.$refs.level1),
                      2: colorToRgba(this.$refs.level2),
                      3: colorToRgba(this.$refs.level3),
                      4: colorToRgba(this.$refs.level4)
                    };
                  },

                  render() {
                    requestAnimationFrame(() => {
                      const container = this.$refs.container;
                      if (!container) return;

                      const colors = this.getColors();
                      const containerWidth = container.clientWidth;

                      // 响应式计算尺寸
                      const weeks = 53;
                      const days = 7;
                      const labelWidth = 28;
                      const monthLabelHeight = 16;
                      const availableWidth = containerWidth - labelWidth - 10;
                      const cellSize = Math.max(8, Math.min(12, Math.floor(availableWidth / weeks) - 3));
                      const cellGap = Math.max(2, Math.min(3, cellSize * 0.25));

                      const gridWidth = weeks * (cellSize + cellGap);
                      const gridHeight = days * (cellSize + cellGap);
                      const width = labelWidth + gridWidth;
                      const height = monthLabelHeight + gridHeight;

                      const today = new Date();
                      const startDate = new Date(today);
                      startDate.setDate(startDate.getDate() - (weeks * days - 1));

                      // 生成月份标签
                      const monthLabels = [];
                      let lastMonth = -1;
                      for (let w = 0; w < weeks; w++) {
                        const d = new Date(startDate);
                        d.setDate(d.getDate() + w * 7);
                        const month = d.getMonth();
                        if (month !== lastMonth) {
                          const x = labelWidth + w * (cellSize + cellGap);
                          monthLabels.push(`<text x="${x}" y="10" class="heatmap-month-label">${this.months[month]}</text>`);
                          lastMonth = month;
                        }
                      }

                      // 生成星期标签
                      const weekLabels = [1, 3, 5].map(d => {
                        const y = monthLabelHeight + d * (cellSize + cellGap) + cellSize * 0.75;
                        return `<text x="0" y="${y}" class="heatmap-label">${this.weekdays[d]}</text>`;
                      });

                      // 生成格子
                      const cells = [];
                      for (let i = 0; i < weeks * days; i++) {
                        const date = new Date(startDate);
                        date.setDate(date.getDate() + i);

                        if (date > today) continue;

                        const dateStr = date.toISOString().split('T')[0];
                        const count = this.data.get(dateStr) || 0;
                        const level = count === 0 ? 0 : count === 1 ? 1 : count === 2 ? 2 : count === 3 ? 3 : 4;

                        const week = Math.floor(i / days);
                        const day = i % days;
                        const x = labelWidth + week * (cellSize + cellGap);
                        const y = monthLabelHeight + day * (cellSize + cellGap);
                        const fillColor = colors[level];
                        const delay = Math.min(i * 3, 800);
                        const hasPostsClass = count > 0 ? 'has-posts' : '';

                        cells.push(`<rect 
                        x="${x}" y="${y}" 
                        width="${cellSize}" height="${cellSize}" 
                        rx="2" ry="2" 
                        fill="${fillColor}" 
                        class="article-heatmap-cell heatmap-cell-animated ${hasPostsClass}" 
                        style="animation-delay: ${delay}ms"
                        data-date="${dateStr}" 
                        data-count="${count}"
                      ></rect>`);
                      }

                      container.innerHTML = `<svg class="article-heatmap-svg" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
                      <g>${monthLabels.join('')}</g>
                      <g>${weekLabels.join('')}</g>
                      <g>${cells.join('')}</g>
                    </svg>`;

                      // 绑定事件
                      this.bindEvents();
                    });
                  },

                  bindEvents() {
                    const container = this.$refs.container;
                    const tooltip = this.$refs.tooltip;
                    if (!container || !tooltip) return;

                    const cells = container.querySelectorAll('.article-heatmap-cell');

                    cells.forEach(cell => {
                      cell.addEventListener('mouseenter', (e) => this.showTooltip(e, cell));
                      cell.addEventListener('mouseleave', () => this.hideTooltip());
                      cell.addEventListener('click', () => this.handleClick(cell));
                    });
                  },

                  showTooltip(e, cell) {
                    const tooltip = this.$refs.tooltip;
                    if (!tooltip) return;

                    const dateStr = cell.getAttribute('data-date');
                    const count = parseInt(cell.getAttribute('data-count') || '0');
                    const posts = this.postsByDate.get(dateStr) || [];

                    const date = new Date(dateStr);
                    const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;

                    let html = `<div class="heatmap-tooltip-date">${formattedDate}</div>`;
                    html += `<div class="heatmap-tooltip-count">${count} 篇文章</div>`;

                    if (posts.length > 0) {
                      html += '<div class="heatmap-tooltip-posts">';
                      posts.slice(0, 3).forEach(post => {
                        html += `<span class="heatmap-tooltip-post">${post.title}</span>`;
                      });
                      if (posts.length > 3) {
                        html += `<span class="heatmap-tooltip-post">还有 ${posts.length - 3} 篇...</span>`;
                      }
                      html += '</div>';
                    }

                    tooltip.innerHTML = html;
                    tooltip.style.display = 'block';

                    const rect = cell.getBoundingClientRect();
                    const tooltipRect = tooltip.getBoundingClientRect();

                    let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
                    let top = rect.top - tooltipRect.height - 8;

                    if (top < 0) top = rect.bottom + 8;
                    if (left < 0) left = 8;
                    if (left + tooltipRect.width > window.innerWidth) {
                      left = window.innerWidth - tooltipRect.width - 8;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';

                    requestAnimationFrame(() => tooltip.classList.add('visible'));
                  },

                  hideTooltip() {
                    const tooltip = this.$refs.tooltip;
                    if (!tooltip) return;

                    tooltip.classList.remove('visible');
                    setTimeout(() => {
                      tooltip.style.display = 'none';
                    }, 150);
                  },

                  handleClick(cell) {
                    const dateStr = cell.getAttribute('data-date');
                    const count = parseInt(cell.getAttribute('data-count') || '0');
                    if (count > 0) {
                      window.location.href = `/archives?date=${dateStr}`;
                    }
                  },

                  setupResizeObserver() {
                    if (typeof ResizeObserver === 'undefined') return;

                    let timeout;
                    new ResizeObserver(() => {
                      clearTimeout(timeout);
                      timeout = setTimeout(() => this.render(), 100);
                    }).observe(this.$refs.container);
                  },

                  setupThemeObserver() {
                    new MutationObserver(() => {
                      requestAnimationFrame(() => this.render());
                    }).observe(document.documentElement, {
                      attributes: true,
                      attributeFilter: ['data-theme']
                    });
                  }
                }));
              });
            </script>
          </th:block>
        </th:block>


        <div x-data="{ tab: 'site' }">
          <!-- Tab 切换块 -->
          <th:block th:switch="${tabStyle}">
            <!-- 药丸风格 - 胶囊徽章 -->
            <th:block th:case="'pills'">
              <div class="mb-8">
                <div class="flex flex-wrap items-center gap-2">
                  <button @click="tab = 'site'"
                    :class="tab === 'site' ? 'bg-base-100 text-base-content shadow-sm border-base-content/10' : 'bg-base-100/60 text-base-content/60 border-base-content/5 hover:bg-base-100 hover:text-base-content hover:shadow-sm hover:border-base-content/10'"
                    class="inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-full text-sm font-medium border transition-all duration-200 cursor-pointer">
                    <span class="icon-[heroicons--home] w-3.5 h-3.5"></span>
                    站内动态
                  </button>
                  <button @click="tab = 'friends'" th:if="${showFriendsTab}"
                    :class="tab === 'friends' ? 'bg-base-100 text-base-content shadow-sm border-base-content/10' : 'bg-base-100/60 text-base-content/60 border-base-content/5 hover:bg-base-100 hover:text-base-content hover:shadow-sm hover:border-base-content/10'"
                    class="inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-full text-sm font-medium border transition-all duration-200 cursor-pointer">
                    <span class="icon-[heroicons--users] w-3.5 h-3.5"></span>
                    朋友动态
                  </button>
                </div>
              </div>
            </th:block>
            <!-- 芯片风格 - iOS Style with Icons -->
            <th:block th:case="'chips'">
              <div class="mb-8">
                <div
                  class="inline-flex p-1 bg-base-200/50 backdrop-blur-sm rounded-xl border border-base-content/10 dark:bg-base-300/40 dark:border-base-content/10">
                  <button @click="tab = 'site'"
                    :class="tab === 'site' ? 'bg-base-100 shadow-md text-base-content dark:bg-base-100/95' : 'text-base-content/60 hover:text-base-content hover:bg-base-100/40'"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                    <span class="icon-[heroicons--squares-2x2] w-4 h-4"></span>站内动态</button>
                  <button @click="tab = 'friends'" th:if="${showFriendsTab}"
                    :class="tab === 'friends' ? 'bg-base-100 shadow-md text-base-content dark:bg-base-100/95' : 'text-base-content/60 hover:text-base-content hover:bg-base-100/40'"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                    <span class="icon-[heroicons--users] w-4 h-4"></span>朋友动态</button>
                </div>
              </div>
            </th:block>
            <!-- 下划线风格 -->
            <th:block th:case="'underline'">
              <div class="mb-8 border-b border-base-200">
                <div class="flex flex-wrap items-center gap-1 -mb-px">
                  <button @click="tab = 'site'"
                    :class="tab === 'site' ? 'text-primary' : 'text-base-content/60 hover:text-base-content'"
                    class="relative px-4 py-3 text-sm font-medium transition-colors duration-200">
                    站内动态
                    <span x-show="tab === 'site'"
                      class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary rounded-full"></span>
                  </button>
                  <button @click="tab = 'friends'" th:if="${showFriendsTab}"
                    :class="tab === 'friends' ? 'text-primary' : 'text-base-content/60 hover:text-base-content'"
                    class="relative px-4 py-3 text-sm font-medium transition-colors duration-200">
                    朋友动态
                    <span x-show="tab === 'friends'"
                      class="absolute bottom-0 left-0 right-0 h-0.5 bg-primary rounded-full"></span>
                  </button>
                </div>
              </div>
            </th:block>
            <!-- 玻璃拟态风格 -->
            <th:block th:case="'glass'">
              <div class="mb-8">
                <div class="flex flex-wrap items-center gap-2">
                  <button @click="tab = 'site'"
                    :class="tab === 'site' ? 'bg-base-100/90 text-base-content shadow-md dark:bg-base-100/95' : 'text-base-content/60 hover:bg-base-100/50 hover:text-base-content'"
                    class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300">站内动态</button>
                  <button @click="tab = 'friends'" th:if="${showFriendsTab}"
                    :class="tab === 'friends' ? 'bg-base-100/90 text-base-content shadow-md dark:bg-base-100/95' : 'text-base-content/60 hover:bg-base-100/50 hover:text-base-content'"
                    class="px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300">朋友动态</button>
                </div>
              </div>
            </th:block>
            <!-- 默认药丸风格 -->
            <th:block th:case="*">
              <div class="mb-8">
                <div class="flex flex-wrap items-center gap-3">
                  <button @click="tab = 'site'"
                    :class="tab === 'site' ? 'bg-primary text-primary-content shadow-lg shadow-primary/30' : 'bg-base-200/80 text-base-content/70 hover:bg-base-300 hover:text-base-content hover:shadow-md'"
                    class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300">站内动态</button>
                  <button @click="tab = 'friends'" th:if="${showFriendsTab}"
                    :class="tab === 'friends' ? 'bg-primary text-primary-content shadow-lg shadow-primary/30' : 'bg-base-200/80 text-base-content/70 hover:bg-base-300 hover:text-base-content hover:shadow-md'"
                    class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300">朋友动态</button>
                </div>
              </div>
            </th:block>
          </th:block>

          <!-- 站内动态 -->
          <div x-show="tab === 'site'" x-transition.opacity
            th:with="sitePosts = ${postFinder.list({page: 1, size: postCount})}">


            <th:block th:switch="${listStyle}">
              <th:block th:case="'modern'">
                <th:block th:replace="~{modules/categories/list-modern :: modern(${sitePosts}, ${postSettings})}" />
              </th:block>
              <th:block th:case="'media_text'">
                <th:block th:replace="~{modules/categories/list-media :: media_text(${sitePosts}, ${postSettings})}" />
              </th:block>
              <th:block th:case="'magazine'">
                <th:block th:replace="~{modules/categories/list-magazine :: magazine(${sitePosts}, ${postSettings})}" />
              </th:block>
              <th:block th:case="'minimal'">
                <th:block th:replace="~{modules/categories/list-minimal :: minimal(${sitePosts}, ${postSettings})}" />
              </th:block>
              <th:block th:case="*">
                <th:block th:replace="~{modules/categories/list-modern :: modern(${sitePosts}, ${postSettings})}" />
              </th:block>
            </th:block>
            <div class="mt-10 text-center">
              <a href="/archives"
                class="group inline-flex items-center gap-1.5 text-sm font-medium text-base-content/50 hover:text-primary transition-colors duration-300">
                View All
                <span
                  class="icon-[heroicons--arrow-right] w-4 h-4 group-hover:translate-x-1 transition-transform duration-300"></span>
              </a>
            </div>
          </div>

          <!-- 朋友动态 -->
          <th:block th:if="${showFriendsTab and friendFinder != null}">
            <div x-show="tab === 'friends'" x-transition.opacity x-cloak th:with="friendPosts = ${friendFinder.list({page: 1, size: friendsCount})},
                       linkGroups = ${linkFinder.groupBy()}">

              <!-- 两列样式 - Bento Grid Style -->
              <div th:if="${friendsListStyle == 'two_columns'}" class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <th:block th:each="friend : ${friendPosts.items}" th:with="spec = ${friend.spec}">
                  <article
                    class="card group relative bg-base-100/80 backdrop-blur-xl border border-base-content/5 shadow-lg rounded-[1.5rem] p-5 hover:shadow-2xl hover:scale-[1.01] hover:bg-base-100 transition-all duration-300 cursor-pointer overflow-hidden">

                    <!-- 顶部元信息 -->
                    <div class="flex items-center gap-3 mb-4">
                      <div class="relative">
                        <img th:src="${spec.logo}" alt=""
                          class="w-10 h-10 rounded-xl object-cover ring-2 ring-base-content/5 group-hover:ring-primary/20 transition-all"
                          loading="lazy" />
                        <div
                          class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-base-100 flex items-center justify-center">
                          <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                        </div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <a th:href="${spec.authorUrl}" target="_blank"
                          class="text-sm font-bold text-base-content truncate block" th:text="${spec.author}">作者</a>
                        <div class="flex items-center gap-1.5 text-xs text-base-content/40">
                          <span th:text="${#temporals.format(spec.pubDate, 'MM-dd HH:mm')}">时间</span>
                          <!-- 动态匹配分组 -->
                          <th:block th:each="group : ${linkGroups}">
                            <th:block th:each="link : ${group.links}">
                              <th:block
                                th:if="${link.spec.url == spec.authorUrl || link.spec.url == spec.authorUrl + '/' || spec.authorUrl == link.spec.url + '/'}">
                                <span>·</span>
                                <span th:text="${group.spec.displayName}">分组</span>
                              </th:block>
                            </th:block>
                          </th:block>
                        </div>
                      </div>
                    </div>

                    <!-- 内容区域 -->
                    <div class="relative z-10">
                      <h3 class="text-base font-bold text-base-content leading-snug mb-2 line-clamp-2">
                        <a th:href="${spec.postLink}" target="_blank" th:text="${spec.title}">标题</a>
                      </h3>
                      <p th:if="${spec.description != null and !spec.description.isEmpty()}"
                        class="text-sm text-base-content/60 line-clamp-2 leading-relaxed mb-4"
                        th:text="${spec.description}">描述...</p>

                      <!-- 底部链接 -->
                      <a th:href="${spec.postLink}" target="_blank"
                        class="inline-flex items-center gap-1.5 text-xs font-semibold text-base-content/40 group-hover:text-primary transition-colors">
                        阅读原文
                        <span
                          class="icon-[heroicons--arrow-right] w-3 h-3 group-hover:translate-x-0.5 transition-transform"></span>
                      </a>
                    </div>
                  </article>
                </th:block>
              </div>

              <!-- 单列样式 - Bento List Style -->
              <div th:if="${friendsListStyle == 'single_column'}" class="space-y-4">
                <th:block th:each="friend : ${friendPosts.items}" th:with="spec = ${friend.spec}">
                  <article
                    class="card group bg-base-100/80 backdrop-blur-xl border border-base-content/5 shadow-lg rounded-[1.5rem] p-5 hover:shadow-xl hover:bg-base-100 transition-all duration-300">
                    <div class="flex items-start gap-4">
                      <!-- 左侧头像 -->
                      <a th:href="${spec.authorUrl}" target="_blank" rel="noopener" class="shrink-0 relative top-1">
                        <img th:src="${spec.logo}" alt="avatar"
                          class="w-12 h-12 rounded-xl object-cover ring-2 ring-base-content/5 group-hover:ring-primary/20 transition-all"
                          loading="lazy" />
                      </a>

                      <!-- 右侧内容 -->
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                          <div class="flex items-center gap-2">
                            <a th:href="${spec.authorUrl}" target="_blank" rel="noopener"
                              class="text-sm font-bold text-base-content" th:text="${spec.author}">作者</a>
                            <!-- 动态匹配分组 (单列) -->
                            <th:block th:each="group : ${linkGroups}">
                              <th:block th:each="link : ${group.links}">
                                <th:block
                                  th:if="${link.spec.url == spec.authorUrl || link.spec.url == spec.authorUrl + '/' || spec.authorUrl == link.spec.url + '/'}">
                                  <span class="text-[10px] bg-base-200/50 px-1.5 py-0.5 rounded text-base-content/40"
                                    th:text="${group.spec.displayName}">分组</span>
                                </th:block>
                              </th:block>
                            </th:block>
                          </div>
                          <time class="text-xs text-base-content/40 font-medium"
                            th:text="${#temporals.format(spec.pubDate, 'yyyy-MM-dd')}">2023-01-01</time>
                        </div>

                        <h3 class="text-base font-bold text-base-content mb-1.5 line-clamp-1">
                          <a th:href="${spec.postLink}" target="_blank" rel="noopener" th:text="${spec.title}">文章标题</a>
                        </h3>

                        <p th:if="${spec.description != null and !spec.description.isEmpty()}"
                          class="text-sm text-base-content/50 line-clamp-2 leading-relaxed"
                          th:text="${spec.description}">文章描述</p>
                      </div>
                    </div>
                  </article>
                </th:block>
              </div>


              <div th:if="${friendPosts.items == null or friendPosts.items.isEmpty()}"
                class="py-16 text-center text-base-content/40 text-sm">
                暂无朋友动态
              </div>
              <div th:if="${friendPosts.items != null and !friendPosts.items.isEmpty()}" class="mt-10 text-center">
                <a href="/friends"
                  class="group inline-flex items-center gap-1.5 text-sm font-medium text-base-content/50 hover:text-primary transition-colors duration-300">
                  View All
                  <span
                    class="icon-[heroicons--arrow-right] w-4 h-4 group-hover:translate-x-1 transition-transform duration-300"></span>
                </a>
              </div>
            </div>
          </th:block>
        </div>
      </section>

      <!-- 右侧：侧边栏 -->
      <aside th:if="${showSidebar}" class="w-80 shrink-0 space-y-6 hidden lg:block sticky top-20 self-start">
        <!-- 动态小工具 -->
        <th:block th:replace="~{modules/widgets/sidebar :: dynamic(${contentSettings})}" />
      </aside>
    </div>

    <!-- ========== 首页扩展模块区域 ========== -->

    <!-- 图库模块 -->
    <th:block th:with="gallerySettings = ${theme.config.index.gallery_settings}">
      <section th:if="${gallerySettings != null and gallerySettings.enable_gallery == true}"
        class="card bg-base-100/80 backdrop-blur-xl shadow-lg border border-base-content/5 rounded-[1.5rem] p-6 sm:p-8 mt-16">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/10 flex items-center justify-center">
              <span class="icon-[heroicons--photo] w-5 h-5 text-primary"></span>
            </div>
            <div>
              <h2 class="text-xl font-bold text-base-content tracking-tight"
                th:text="${gallerySettings?.gallery_title} ?: '图库'">图库</h2>
              <p class="text-xs text-base-content/40 font-medium mt-0.5"
                th:text="${gallerySettings?.gallery_subtitle} ?: 'Focus Moments'">Focus Moments</p>
            </div>
          </div>
          <a href="/photos"
            class="group inline-flex items-center gap-1.5 text-sm font-medium text-base-content/50 hover:text-primary transition-colors duration-300">
            View All
            <span
              class="icon-[heroicons--arrow-right] w-4 h-4 group-hover:translate-x-1 transition-transform duration-300"></span>
          </a>
        </div>

        <!-- 未安装插件时的提醒 -->
        <th:block th:unless="${pluginFinder.available('PluginPhotos')}">
          <div class="text-center py-12 bg-base-100/50 rounded-3xl border border-base-content/5 border-dashed">
            <span class="icon-[heroicons--photo] w-12 h-12 mx-auto text-base-content/20 mb-4 block"></span>
            <p class="text-base-content/60 mb-4">需要安装图库插件来展示照片</p>
            <a href="https://www.halo.run/store/apps/app-BmQJW" target="_blank"
              class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 border border-primary/20 rounded-lg text-primary hover:bg-primary/20 transition-colors duration-300">
              <span class="icon-[material-symbols--download] w-4 h-4"></span>
              <span>下载图库插件</span>
            </a>
          </div>
        </th:block>

        <!-- 已安装插件时显示内容 -->
        <th:block th:if="${pluginFinder.available('PluginPhotos')}">
          <th:block th:with="groups = ${photoFinder.groupBy()}">
            <div th:if="${groups != null && !groups.isEmpty()}"
              class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
              <a th:each="group : ${groups}" th:href="|/photos?group=${group.metadata.name}|"
                class="group relative aspect-[4/3] rounded-[1.25rem] overflow-hidden shadow-md hover:shadow-2xl transition-all duration-500 ease-out cursor-pointer ring-1 ring-base-content/5 hover:ring-primary/30">

                <!-- 背景图容器 -->
                <div class="absolute inset-0 bg-base-200 overflow-hidden">
                  <img th:if="${group.photos != null && !group.photos.isEmpty()}" th:src="${group.photos[0].spec.url}"
                    th:alt="${group.spec.displayName}"
                    class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-105"
                    loading="lazy" />
                  <div th:if="${group.photos == null || group.photos.isEmpty()}"
                    class="w-full h-full flex items-center justify-center bg-gradient-to-br from-base-200 to-base-300">
                    <span class="icon-[heroicons--photo] w-12 h-12 text-base-content/15"></span>
                  </div>
                </div>

                <!-- 渐变遮罩 & 文字内容 -->
                <div
                  class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/5 to-transparent opacity-90 group-hover:opacity-100 transition-opacity duration-300">
                  <div class="absolute bottom-0 left-0 right-0 p-4 sm:p-5">
                    <p class="text-white font-bold text-base sm:text-lg tracking-wide drop-shadow-lg truncate"
                      th:text="${group.spec.displayName}">分组名称</p>
                    <div class="flex items-center gap-2 mt-2">
                      <span
                        class="text-white/90 text-xs font-medium backdrop-blur-md bg-white/15 px-2.5 py-1 rounded-full border border-white/10"
                        th:text="|${group.status.photoCount ?: 0} 张照片|">0 张照片</span>
                    </div>
                  </div>
                </div>

                <!-- 玻璃高光效果 -->
                <div
                  class="absolute inset-x-0 top-0 h-1/2 bg-gradient-to-b from-white/8 to-transparent pointer-events-none">
                </div>
              </a>
            </div>
            <!-- 空状态 -->
            <div th:if="${groups == null || groups.isEmpty()}"
              class="text-center py-16 bg-base-100/50 rounded-3xl border border-base-content/5 border-dashed">
              <span class="icon-[heroicons--photo] w-12 h-12 mx-auto text-base-content/20 mb-3"></span>
              <p class="text-base-content/40 font-medium">暂无图库分组</p>
            </div>
          </th:block>
        </th:block>
      </section>
    </th:block>



    <!-- 友情链接模块 -->
    <th:block th:with="linksSettings = ${theme.config.index.links_settings}">
      <section th:if="${linksSettings != null and linksSettings.enable_links == true}"
        class="card bg-base-100/80 backdrop-blur-xl shadow-lg border border-base-content/5 rounded-[1.5rem] p-6 sm:p-8 mt-16">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-2xl bg-gradient-to-br from-secondary/20 to-secondary/10 flex items-center justify-center">
              <span class="icon-[heroicons--link] w-5 h-5 text-secondary"></span>
            </div>
            <div>
              <h2 class="text-xl font-bold text-base-content tracking-tight"
                th:text="${linksSettings?.links_title} ?: '友情链接'">友情链接</h2>
              <p class="text-xs text-base-content/40 font-medium mt-0.5"
                th:text="${linksSettings?.links_subtitle} ?: 'Friends & Partners'">Friends & Partners</p>
            </div>
          </div>
          <a href="/links"
            class="group inline-flex items-center gap-1.5 text-sm font-medium text-base-content/50 hover:text-primary transition-colors duration-300">
            View All
            <span
              class="icon-[heroicons--arrow-right] w-4 h-4 group-hover:translate-x-1 transition-transform duration-300"></span>
          </a>
        </div>

        <!-- 未安装插件时的提醒 -->
        <th:block th:unless="${pluginFinder.available('PluginLinks')}">
          <div class="text-center py-12 bg-base-100/50 rounded-3xl border border-base-content/5 border-dashed">
            <span class="icon-[heroicons--link] w-12 h-12 mx-auto text-base-content/20 mb-4 block"></span>
            <p class="text-base-content/60 mb-4">需要安装友链插件来展示链接</p>
            <a href="https://www.halo.run/store/apps/app-hfbQg" target="_blank"
              class="inline-flex items-center gap-2 px-4 py-2 bg-primary/10 border border-primary/20 rounded-lg text-primary hover:bg-primary/20 transition-colors duration-300">
              <span class="icon-[material-symbols--download] w-4 h-4"></span>
              <span>下载友链插件</span>
            </a>
          </div>
        </th:block>

        <!-- 已安装插件时显示内容 -->
        <th:block th:if="${pluginFinder.available('PluginLinks')}">
          <th:block th:with="groups = ${linkFinder.groupBy()}">
            <div th:if="${groups != null && !groups.isEmpty()}"
              class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
              <th:block th:each="group : ${groups}"
                th:if="${linksSettings.links_groups == null || linksSettings.links_groups.isEmpty() || #lists.contains(linksSettings.links_groups, group.metadata.name)}">
                <a th:each="link : ${group.links}" th:href="${link.spec.url}" target="_blank" rel="noopener"
                  th:title="${link.spec.description}"
                  class="group flex flex-col items-center text-center gap-3 p-2 rounded-xl transition-opacity hover:opacity-80">

                  <!-- 头像容器 -->
                  <div class="relative transition-transform duration-300 group-hover:scale-105">
                    <!-- 阴影 -->
                    <div
                      class="absolute inset-2 bg-black/20 rounded-full blur-md translate-y-2 opacity-0 group-hover:opacity-40 transition-opacity duration-300">
                    </div>
                    <!-- 头像主体 -->
                    <div
                      class="relative w-16 h-16 rounded-[1.25rem] bg-base-100 shadow-sm overflow-hidden ring-1 ring-base-content/5">
                      <img th:if="${link.spec.logo != null && !link.spec.logo.isEmpty()}" th:src="${link.spec.logo}"
                        th:alt="${link.spec.displayName}" class="w-full h-full object-cover bg-base-200"
                        loading="lazy" />
                      <div th:if="${link.spec.logo == null || link.spec.logo.isEmpty()}"
                        class="w-full h-full flex items-center justify-center bg-gradient-to-br from-base-200 to-base-300 text-base-content/40">
                        <span class="text-xl font-bold"
                          th:text="${#strings.substring(link.spec.displayName,0,1)}">L</span>
                      </div>
                    </div>
                  </div>

                  <div class="flex flex-col gap-0.5 w-full px-1">
                    <span class="text-xs font-semibold text-base-content/90 truncate w-full"
                      th:text="${link.spec.displayName}">链接名</span>
                    <span class="text-[10px] text-base-content/40 truncate w-full"
                      th:text="${link.spec.description ?: 'No description'}">描述</span>
                  </div>
                </a>
              </th:block>
            </div>
            <!-- 空状态 -->
            <div th:if="${groups == null || groups.isEmpty()}" class="text-center py-12">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-3xl bg-base-200/50 mb-4">
                <span class="icon-[heroicons--link] w-8 h-8 text-base-content/30"></span>
              </div>
              <p class="text-base-content/40 font-medium">暂无友情链接</p>
            </div>
          </th:block>
        </th:block>
      </section>
    </th:block>

  </div>


</th:block>