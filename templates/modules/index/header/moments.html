<div class="absolute bottom-20 left-1/2 transform -translate-x-1/2 z-30 w-full max-w-5xl px-4"
    th:if="${theme.config.index.moment_settings.show_moment}">

    <!-- 未安装插件时的简单提醒 -->
    <th:block th:unless="${pluginFinder.available('PluginMoments')}">
        <div class="moment-card shadow-xl rounded-2xl border border-blue-500/20 backdrop-blur-sm"
            onmousemove="handleMomentCardGlow(event, this)" onmouseenter="showMomentCardGlow(this)"
            onmouseleave="hideMomentCardGlow(this)">
            <!-- 发光效果容器 -->
            <div class="moment-glow-container">
                <div class="moment-glow"></div>
            </div>
            <div class="p-5 text-center">
                <p class="text-gray-300 mb-4">需要安装瞬间插件来展示动态内容</p>
                <a href="https://github.com/halo-sigs/plugin-moments" target="_blank"
                    class="inline-flex items-center space-x-2 px-4 py-2 bg-blue-500/20 border border-blue-500/30 rounded-lg transition-all duration-300 text-blue-400 hover:text-blue-300 hover:bg-blue-500/30">
                    <span class="icon-[material-symbols--download] w-4 h-4"></span>
                    <span>下载瞬间插件</span>
                </a>
            </div>
        </div>
    </th:block>

    <!-- 已安装插件时显示完整功能 -->
    <th:block th:if="${pluginFinder.available('PluginMoments')}">
        <div class="moment-card shadow-xl rounded-2xl border border-blue-500/20 backdrop-blur-sm"
            onmousemove="handleMomentCardGlow(event, this)" onmouseenter="showMomentCardGlow(this)"
            onmouseleave="hideMomentCardGlow(this)">
            <!-- 发光效果容器 -->
            <div class="moment-glow-container">
                <div class="moment-glow"></div>
            </div>
            <div class="moment-card-content p-5">
                <!-- 标题栏 - 简约设计 -->
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center space-x-2">
                        <span class="icon-[material-symbols--chat-rounded] w-5 h-5 text-blue-400"></span>
                        <h3 class="moment-title text-lg font-medium text-gray-200"
                            th:text="${theme.config.index.moment_settings.moment_title ?: '瞬间'}">瞬间</h3>
                    </div>
                    <!-- 发布瞬间按钮 - 仅登录用户可见 -->
                    <button th:if="${#authorization.expression('isAuthenticated()')}"
                        onclick="document.getElementById('talk-modal').classList.remove('hidden'); document.getElementById('talk-modal').style.display = 'flex';"
                        class="p-2 hover:scale-110 transition-all duration-300 group" title="发布瞬间">
                        <span
                            class="icon-[material-symbols--add] w-5 h-5 text-gray-300 group-hover:text-blue-400 transition-colors"></span>
                    </button>
                    <!-- 查看全部按钮 - 未登录用户显示 -->
                    <a th:unless="${#authorization.expression('isAuthenticated()')}" href="/moments"
                        class="p-2 hover:scale-110 transition-all duration-300 group" title="查看全部瞬间">
                        <span
                            class="icon-[material-symbols--arrow-forward] w-5 h-5 text-gray-300 group-hover:text-blue-400 transition-colors"></span>
                    </a>
                </div>

                <!-- 响应式网格布局：优化间距和视觉效果 -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <th:block th:each="moment, momentStat : ${momentFinder.listAll()}"
                        th:with="content=${moment.spec.content}">
                        <!-- 根据索引动态设置响应式显示类 -->
                        <div th:if="${not #strings.isEmpty(content.raw) and momentStat.index < 3}" th:class="${'moment-item rounded-xl p-4 backdrop-blur-sm' + 
                                      (momentStat.index == 1 ? ' hidden md:block' : '') + 
                                      (momentStat.index == 2 ? ' hidden lg:block' : '')}"
                            th:classappend="${momentStat.index % 2 == 0 ? ' rotate-slight-left' : ' rotate-slight-right'}">
                            <!-- 瞬间内容 -->
                            <p class="text-gray-200 mb-3 line-clamp-3" th:utext="${content.raw}"></p>

                            <!-- 底部信息栏 -->
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex items-center space-x-2">
                                    <span class="icon-[material-symbols--schedule] w-3.5 h-3.5 text-gray-400"></span>
                                    <span class="text-xs text-gray-400"
                                        th:text="${#temporals.format(moment.spec.releaseTime, 'MM-dd HH:mm')}"></span>
                                </div>
                                <div class="flex items-center space-x-1.5">
                                    <!-- 点赞数量 -->
                                    <span class="text-xs text-gray-400" th:text="${moment.stats.upvote ?: 0}">0</span>
                                    <!-- 点赞按钮 -->
                                    <button onclick="upvoteMoment(this)" th:data-moment-name="${moment.metadata.name}"
                                        class="p-1.5 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 hover:border-red-400/30 transition-all flex items-center group moment-like-btn"
                                        title="点赞">
                                        <span
                                            class="icon-[material-symbols--favorite] w-3.5 h-3.5 text-white/60 group-hover:text-red-400 transition-colors"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>
    </th:block>
</div>

<!-- 发布瞬间模态框 - 仅登录用户可见 -->
<div id="talk-modal" th:if="${#authorization.expression('isAuthenticated()')}"
    class="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] items-center justify-center hidden moment-modal"
    onclick="if(event.target === this) { document.getElementById('talk-modal').classList.add('hidden'); document.getElementById('talk-modal').style.display = 'none'; }"
    style="display: none;">
    <link rel="stylesheet" th:href="@{/assets/emoji/emoji-selector.css?v={version}(version=${theme.spec.version})}">
    <script th:src="@{/assets/emoji/emoji-selector.js?v={version}(version=${theme.spec.version})}"></script>

    <div class="w-full max-w-md mx-4 bg-gray-900/90 rounded-2xl border border-blue-500/20 shadow-2xl overflow-hidden backdrop-blur-md"
        onclick="event.stopPropagation();">
        <!-- 模态框标题 -->
        <div class="px-5 py-4 border-b border-gray-700/50 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <span class="icon-[material-symbols--edit] w-5 h-5 text-blue-400"></span>
                <h3 class="text-lg font-medium text-gray-200">轻发布</h3>
            </div>
            <button class="p-1.5 text-gray-400 hover:text-gray-200 transition-all"
                onclick="document.getElementById('talk-modal').classList.add('hidden'); document.getElementById('talk-modal').style.display = 'none';"
                title="关闭">
                <span class="icon-[material-symbols--close] w-5 h-5"></span>
            </button>
        </div>

        <!-- 模态框内容 -->
        <div class="p-5 space-y-4">
            <form class="space-y-4">
                <!-- 文本输入区 -->
                <div class="relative">
                    <textarea id="talk-content"
                        class="w-full bg-gray-800/70 border border-gray-700/50 rounded-xl p-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500/30 transition-all resize-none"
                        rows="4" placeholder="分享你的想法..." maxlength="200"
                        oninput="document.getElementById('char-count').textContent = this.value.length + '/200'"></textarea>

                    <!-- 字数统计 - 浮动在右下角 -->
                    <div class="absolute bottom-3 right-3">
                        <span id="char-count"
                            class="text-xs text-gray-500 bg-gray-800/80 px-2 py-1 rounded-full backdrop-blur-sm">0/200</span>
                    </div>
                </div>

                <!-- 底部工具栏 -->
                <div class="flex items-center justify-between pt-2">
                    <!-- 左侧工具按钮 -->
                    <div class="flex items-center space-x-2">
                        <button type="button" id="emoji-trigger-btn"
                            onclick="showEmojiSelector(document.getElementById('talk-content'), this)"
                            class="flex items-center justify-center w-9 h-9 rounded-full bg-gray-800/70 hover:bg-yellow-500/10 border border-gray-700/50 hover:border-yellow-500/30 transition-all duration-300 group"
                            title="添加表情">
                            <span
                                class="icon-[material-symbols--sentiment-satisfied] w-4 h-4 text-gray-400 group-hover:text-yellow-400 transition-colors"></span>
                        </button>
                    </div>

                    <!-- 右侧发布按钮 -->
                    <button type="submit" id="publish-btn"
                        class="publish-btn flex items-center justify-center w-10 h-10 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-blue-500/25"
                        title="发布">
                        <span class="icon-[material-symbols--send] w-4 h-4"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        /**
         * 简化版瞬间发布功能
         */
        (function () {
            'use strict';

            /**
             * 发布瞬间
             */
            async function publishMoment(content) {


                const momentName = 'moment-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);


                try {
                    const response = await fetch('/apis/moment.halo.run/v1alpha1/moments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiVersion: 'moment.halo.run/v1alpha1',
                            kind: 'Moment',
                            metadata: {
                                name: momentName,
                                labels: { 'moment.halo.run/visible': 'PUBLIC' }
                            },
                            spec: {
                                approved: true,
                                approvedTime: new Date().toISOString(),
                                content: {
                                    raw: content.trim(),
                                    html: content.trim().replace(/\n/g, '<br>')
                                },
                                owner: 'system',
                                visible: 'PUBLIC',
                                releaseTime: new Date().toISOString(),
                                tags: []
                            }
                        })
                    });



                    if (response.ok) {

                        return true;
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('发布失败:', errorData);
                        return false;
                    }
                } catch (error) {
                    console.error('发布异常:', error);
                    return false;
                }
            }

            /**
             * 局部刷新瞬间列表
             */
            async function refreshMomentsList() {

                try {
                    const response = await fetch(window.location.href);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // 找到新的瞬间网格内容
                    const newGrid = doc.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');
                    const currentGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3');

                    if (newGrid && currentGrid) {
                        currentGrid.innerHTML = newGrid.innerHTML;

                    }
                } catch (error) {
                    console.error('局部刷新失败:', error);
                }
            }

            /**
             * 处理发布表单提交
             */
            async function handlePublishSubmit(event) {
                event.preventDefault();


                const contentInput = document.getElementById('talk-content');
                const publishBtn = document.getElementById('publish-btn');
                const modal = document.getElementById('talk-modal');
                const content = contentInput.value.trim();



                // 显示加载状态
                const originalBtnContent = publishBtn.innerHTML;
                publishBtn.disabled = true;
                publishBtn.innerHTML = '<span class="icon-[material-symbols--hourglass-empty] w-5 h-5 animate-spin"></span>';

                try {
                    const success = await publishMoment(content);

                    if (success) {


                        // 清空输入框和重置计数
                        contentInput.value = '';
                        document.getElementById('char-count').textContent = '0/200';

                        // 关闭模态框
                        modal.classList.add('hidden');
                        modal.style.display = 'none';

                        // 局部刷新瞬间列表
                        setTimeout(() => {
                            refreshMomentsList();
                        }, 1000);
                    }
                } finally {
                    // 恢复按钮状态
                    publishBtn.disabled = false;
                    publishBtn.innerHTML = originalBtnContent;
                }
            }

            // 绑定事件
            document.addEventListener('DOMContentLoaded', function () {


                const publishForm = document.querySelector('#talk-modal form');
                if (publishForm) {
                    publishForm.addEventListener('submit', handlePublishSubmit);

                }
            });

        })();
    </script>
</div>