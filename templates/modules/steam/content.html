<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ========================================== -->
<!--        Steam Ê∏∏ÊàèÂ∫ì‰∏ª‰ΩìÂÜÖÂÆπ                 -->
<!-- ========================================== -->

<main class="steam-page relative" th:fragment="steam-content" th:with="profile = ${steamFinder.getProfile()},
           recentGames = ${steamFinder.getRecentGames(recentGamesLimit)},
           stats = ${steamFinder.getStats()},
           badges = ${steamFinder.getBadges()}">

  <div class="max-w-6xl mx-auto px-4 py-8">

    <!-- ÈîôËØØÊèêÁ§∫ -->
    <div th:if="${profile == null || stats == null}" class="alert alert-warning mb-6 rounded-2xl steam-animate-in">
      <span class="icon-[heroicons--exclamation-triangle] w-5 h-5"></span>
      <span>ÈÉ®ÂàÜ Steam Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÂà∑Êñ∞ÈáçËØïÊàñÊ£ÄÊü•Êèí‰ª∂ÈÖçÁΩÆ„ÄÇ</span>
    </div>

    <!-- ========================================== -->
    <!--     ‰∏§Ê†èÂ∏ÉÂ±Ä - Steam ÂÆòÊñπÈ£éÊ†º              -->
    <!-- ========================================== -->
    <div th:if="${profile != null}" th:with="p = ${profile}" class="steam-layout steam-animate-in">

      <!-- ================================ -->
      <!-- Â∑¶‰æß‰∏ªÊ†è                          -->
      <!-- ================================ -->
      <div class="steam-main">

        <!-- Profile Header -->
        <div class="steam-profile-header">
          <div class="steam-profile-avatar" th:classappend="${p?.playing ? 'playing' : ''}">
            <img th:src="${p?.summary?.avatarFull}" th:alt="${p?.summary?.personaName}" 
                 loading="eager" 
                 decoding="async"
                 class="steam-avatar-img" />
          </div>
          <div class="steam-profile-info">
            <div class="flex items-center gap-2">
              <h1 class="steam-profile-name" th:text="${p?.summary?.personaName}">Steam User</h1>
              <!-- Level Badge (Moved from Sidebar) -->
              <span class="badge badge-outline gap-1 font-mono"
                th:classappend="${(badges?.playerLevel ?: p?.steamLevel ?: 0) >= 100 ? 'badge-warning' : 'badge-neutral'}"
                style="border-color: var(--color-primary); color: var(--color-primary);">
                <span class="text-xs">Lv.</span>
                <span class="font-bold" th:text="${badges?.playerLevel ?: p?.steamLevel ?: 0}">0</span>
              </span>
            </div>

            <!-- Status (Moved from Sidebar) -->
            <div class="steam-status-subtitle flex items-center gap-2 text-sm mt-1">
              <span class="w-2 h-2 rounded-full"
                th:classappend="${p?.playing ? 'bg-success' : (p?.summary?.personaState == 1 ? 'bg-info' : 'bg-base-content/30')}"></span>
              <span th:text="${p?.statusText}" class="opacity-70">Âú®Á∫ø</span>
              <span th:if="${p?.playing}" class="text-success text-xs">
              </span>
              </span>
            </div>
          </div>
        </div>

        <!-- ÊúÄÊñ∞Âä®ÊÄÅ (ÁÉ≠ÂäõÂõæ) -->
        <div th:if="${showHeatmap}" class="steam-activity-section">
          <!-- ÁÉ≠ÂäõÂõæÂÆπÂô® -->
          <div class="steam-heatmap-inline relative">
            <div class="heatmap-container relative min-h-[120px]">
              <div id="steam-heatmap-grid" class="steam-heatmap-grid" th:data-days="${heatmapDays}"
                th:data-api-url="@{/apis/api.steam.halo.run/v1alpha1/heatmap/records}"></div>

              <!-- Tooltip -->
              <div id="steam-heatmap-tooltip" class="steam-heatmap-tooltip"></div>

              <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
              <div id="steam-heatmap-loading" class="steam-heatmap-status">
                <span class="loading loading-spinner loading-md opacity-50"></span>
              </div>
              <!-- Á©∫Áä∂ÊÄÅ -->
              <div id="steam-heatmap-empty" class="steam-heatmap-status" style="display: none;">
                <span class="text-xs opacity-50">ÊöÇÊó†Êï∞ÊçÆ</span>
              </div>
              <!-- ÈîôËØØÁä∂ÊÄÅ -->
              <div id="steam-heatmap-error" class="steam-heatmap-status" style="display: none;">
                <span class="text-xs text-error opacity-50">Âä†ËΩΩÂ§±Ë¥•</span>
              </div>
            </div>
            <!-- È¢úËâ≤Âõæ‰æã -->
            <div class="steam-heatmap-legend">
              <span class="steam-legend-text">Less</span>
              <span class="steam-legend-dot l0"></span>
              <span class="steam-legend-dot l1"></span>
              <span class="steam-legend-dot l2"></span>
              <span class="steam-legend-dot l3"></span>
              <span class="steam-legend-text">More</span>
            </div>
          </div>
        </div>

      </div>
      <!-- End of steam-main -->

      <!-- ================================ -->
      <!-- Âè≥‰æßËæπÊ†è                          -->
      <!-- ================================ -->
      <div class="steam-sidebar">

        <!-- ÂæΩÁ´†Â±ïÁ§∫ -->
        <div th:if="${badges != null && badges.badges != null && !badges.badges.isEmpty()}" class="steam-sidebar-card">
          <div class="steam-sidebar-title">
            ÂæΩÁ´† <span th:text="${badges.totalBadges}">0</span>
          </div>
          <div class="steam-badges-grid">
            <th:block th:each="badge, iter : ${badges.badges}" th:if="${iter.index < 8}">
              <div class="steam-badge-item" th:title="${(badge.badgeName ?: badge.displayName) + ' Lv.' + badge.level}">
                <img th:if="${badge.imageUrl != null && !badge.imageUrl.isEmpty()}" 
                     th:src="${badge.imageUrl}"
                     th:alt="${badge.displayName}" 
                     loading="lazy" 
                     decoding="async"
                     class="steam-badge-img" />
              </div>
            </th:block>
          </div>
        </div>

        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div th:if="${stats != null}" class="steam-sidebar-card steam-stats-list">
          <div class="steam-stat-item">
            <span class="steam-stat-label">Ê∏∏Êàè</span>
            <span class="steam-stat-value" th:text="${stats.totalGames}">0</span>
          </div>
          <div class="steam-stat-item">
            <span class="steam-stat-label">ÊÄªÊó∂Èïø</span>
            <span class="steam-stat-value"
              th:text="${#numbers.formatDecimal(stats.totalPlaytimeMinutes / 60.0, 0, 1)} + 'h'">0h</span>
          </div>
          <!-- 2Âë®Êó∂Èïø (Moved from Header) -->
          <div class="steam-stat-item">
            <span class="steam-stat-label">ÊúÄËøë2Âë®</span>
            <span class="steam-stat-value text-primary">
              <span th:text="${stats.recentPlaytimeMinutes / 60}">0</span>
              <span th:if="${stats.recentPlaytimeMinutes % 60 > 0}"
                th:text="'.' + ${stats.recentPlaytimeMinutes % 60 / 6}"></span>
              h
            </span>
          </div>

        </div>
      </div>
    </div>
  </div>
  <!-- End of steam-layout -->

  <div class="max-w-6xl mx-auto px-4 pb-8">
    <!-- ========================================== -->
    <!--     ÊúÄËøëÊ∏∏Áé© - ÁΩëÊ†ºÂç°ÁâáÂ∏ÉÂ±Ä               -->
    <!-- ========================================== -->
    <section th:if="${recentGames != null && !recentGames.isEmpty()}"
      class="steam-section steam-animate-in steam-stagger-1">
      <div class="steam-section-header">
        <div class="steam-section-icon recent">
          <span class="icon-[heroicons--clock] w-5 h-5"></span>
        </div>
        <h2 class="steam-section-title">ÊúÄËøëÊ∏∏Áé©</h2>
      </div>

      <!-- Ê∏∏ÊàèÂç°ÁâáÁΩëÊ†º -->
      <div class="steam-library-grid">
        <th:block th:each="game, iter : ${recentGames}" th:if="${iter.index < 10}">
          <a th:href="@{'https://store.steampowered.com/app/' + ${game.appId}}" target="_blank" class="steam-game-card">
            <div class="steam-game-card-image">
              <img th:src="${game.headerImageUrl}" 
                   th:alt="${game.name}" 
                   loading="lazy" 
                   decoding="async"
                   class="steam-game-img" />
            </div>
            <div class="steam-game-card-info">
              <div class="steam-game-card-name" th:text="${game.name}">Game</div>
              <div class="steam-game-card-meta">
                <span class="steam-game-card-playtime" th:text="${game.playtime2WeeksFormatted}">0h</span>
              </div>
              <!-- ÊàêÂ∞±ËøõÂ∫¶Êù° - ÂêåË°åÊòæÁ§∫ -->
              <div class="steam-game-card-achievement-row" th:if="${game.achievementProgressText != null}">
                <span class="steam-game-card-achievement" th:text="${game.achievementProgressText}"></span>
                <div class="steam-achievement-bar" th:data-progress="${game.achievementProgressText}">
                  <div class="steam-achievement-fill"></div>
                </div>
              </div>
            </div>
          </a>
        </th:block>
      </div>
    </section>

    <!-- ========================================== -->
    <!--     Ê∏∏ÊàèÂ∫ì - ÁΩëÊ†ºÂç°ÁâáÂ∏ÉÂ±Ä                 -->
    <!-- ========================================== -->
    <section th:if="${games != null}" class="steam-section steam-animate-in steam-stagger-2">
      <div class="steam-section-header">
        <div class="steam-section-icon library">
          <span class="icon-[heroicons--squares-2x2] w-5 h-5"></span>
        </div>
        <h2 class="steam-section-title">Ê∏∏ÊàèÂ∫ì</h2>
      </div>

      <!-- Ê∏∏ÊàèÂç°ÁâáÁΩëÊ†º -->
      <div th:if="${!games.items.isEmpty()}" class="steam-library-grid">
        <th:block th:each="game : ${games.items}">
          <a th:if="${enableGameLink}" th:href="'https://store.steampowered.com/app/' + ${game.appId}" target="_blank"
            class="steam-game-card">
            <div class="steam-game-card-image">
              <img th:src="${game.headerImageUrl}" 
                   th:alt="${game.name}" 
                   loading="lazy" 
                   decoding="async"
                   class="steam-game-img" />
            </div>
            <div class="steam-game-card-info">
              <div class="steam-game-card-name" th:text="${game.name}">Game</div>
              <div class="steam-game-card-meta">
                <span class="steam-game-card-playtime" th:text="${game.playtimeFormatted}">0h</span>
                <span th:if="${game.lastPlayedFormatted}" class="steam-game-card-lastplayed"
                  th:text="${game.lastPlayedFormatted}"></span>
              </div>
            </div>
          </a>
          <div th:unless="${enableGameLink}" class="steam-game-card">
            <div class="steam-game-card-image">
              <img th:src="${game.headerImageUrl}" 
                   th:alt="${game.name}" 
                   loading="lazy" 
                   decoding="async"
                   class="steam-game-img" />
            </div>
            <div class="steam-game-card-info">
              <div class="steam-game-card-name" th:text="${game.name}">Game</div>
              <div class="steam-game-card-meta">
                <span class="steam-game-card-playtime" th:text="${game.playtimeFormatted}">0h</span>
                <span th:if="${game.lastPlayedFormatted}" class="steam-game-card-lastplayed"
                  th:text="${game.lastPlayedFormatted}"></span>
              </div>
            </div>
          </div>
        </th:block>
      </div>

      <!-- Á©∫Áä∂ÊÄÅ -->
      <div th:if="${games.items.isEmpty()}" class="steam-empty-state">
        <div class="steam-empty-icon">üéÆ</div>
        <div class="steam-empty-title">ÊöÇÊó†Ê∏∏ÊàèÊï∞ÊçÆ</div>
        <div class="steam-empty-desc">Ê∏∏ÊàèÂ∫ì‰∏∫Á©∫ÔºåËØ∑Ê£ÄÊü• Steam Ë¥¶Âè∑ËÆæÁΩÆ</div>
      </div>

      <!-- ÂàÜÈ°µ -->
      <div th:if="${games.totalPages > 1}" class="steam-pagination">
        <div class="steam-pagination-inner">
          <a th:if="${games.hasPrevious()}" th:href="@{${games.prevUrl}}" class="steam-pagination-btn" title="‰∏ä‰∏ÄÈ°µ">
            <span class="icon-[heroicons--chevron-left] w-5 h-5"></span>
          </a>
          <span class="steam-pagination-info">
            <span th:text="${games.page}">1</span> / <span th:text="${games.totalPages}">1</span>
          </span>
          <a th:if="${games.hasNext()}" th:href="@{${games.nextUrl}}" class="steam-pagination-btn" title="‰∏ã‰∏ÄÈ°µ">
            <span class="icon-[heroicons--chevron-right] w-5 h-5"></span>
          </a>
        </div>
      </div>
    </section>

  </div>
</main>

</html>