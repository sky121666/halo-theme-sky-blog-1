<!-- ========================================== -->
<!--     瞬间列表页 - 朋友圈+苹果风格               -->
<!-- ========================================== -->
<th:block th:fragment="content">

  <th:block th:with="
    rootCfg=${theme.config.moments_settings},
    cfg=${rootCfg.basic_info},
    sidebarCfg=${rootCfg.sidebar_settings},
    pageTitle=${cfg?.page_title ?: '瞬间'},
    enableUpvote=${cfg?.enable_upvote != false},
    enableComment=${cfg?.enable_comment != false},
    publishSettings=${rootCfg?.publish_settings},
    enablePublish=${publishSettings?.enable_publish != false},
    enableImageUpload=${enablePublish && (publishSettings?.enable_image_upload != false)},
    enableVideoUpload=${enablePublish && (publishSettings?.enable_video_upload != false)},
    enableAudioUpload=${enablePublish && (publishSettings?.enable_audio_upload != false)},
    showSidebar=${sidebarCfg?.show_sidebar == true},
    globalSidebarCfg = ${theme.config.general.sidebar_settings},
    useCustomSidebar = ${sidebarCfg?.enable_custom_sidebar == true},
    sidebarPosition = ${useCustomSidebar ? (sidebarCfg?.sidebar_position ?: 'right') : (globalSidebarCfg?.position ?: 'right')}
  ">

    <div class="mx-auto px-4 py-6 md:py-10" th:classappend="${showSidebar} ? 'max-w-5xl' : 'max-w-2xl'">
      <div class="flex gap-8" th:classappend="${sidebarPosition == 'left'} ? 'flex-row-reverse' : ''">

        <!-- 主内容区 -->
        <section class="flex-1 min-w-0">

          <!-- 标签筛选 + 发布按钮 -->
          <div class="mb-6 flex items-center justify-between gap-4">
            <!-- 左侧标签 -->
            <div th:if="${tags != null && !tags.isEmpty()}"
              class="flex gap-2 overflow-x-auto pb-1 scrollbar-none flex-1">
              <a th:href="@{/moments}" class="btn btn-sm rounded-full"
                th:classappend="${param.tag == null || #lists.isEmpty(param.tag)} ? 'btn-primary' : 'btn-ghost'">
                全部
              </a>
              <th:block th:each="tag : ${tags}">
                <a th:href="@{/moments(tag=${tag.name})}" class="btn btn-sm rounded-full"
                  th:classappend="${#lists.contains(param.tag, tag.name)} ? 'btn-primary' : 'btn-ghost'"
                  th:text="${tag.name}">标签</a>
              </th:block>
            </div>

            <!-- 右侧发布按钮（启用发布且登录用户可见） -->
            <button th:if="${enablePublish && #authorization.expression('isAuthenticated()')}"
              onclick="openMomentModal()" class="btn btn-ghost btn-sm gap-1 shrink-0">
              <span class="icon-[heroicons--pencil-square] w-4 h-4"></span>
              <span>发布</span>
            </button>
          </div>

          <!-- 瞬间列表 -->
          <div id="moments-list" th:if="${moments != null && moments.total > 0}" class="space-y-4">

            <th:block th:each="moment : ${moments.items}" th:with="content=${moment.spec.content}">

              <article class="card bg-base-100 shadow-sm rounded-2xl overflow-hidden" x-data="{ showComment: false }">
                <div class="p-4">
                  <!-- 头部：头像 + 用户名 + 时间 -->
                  <div class="flex items-center gap-3 mb-3">
                    <div class="avatar">
                      <a th:href="@{/authors/{name}(name=${moment.owner.name})}"
                        class="w-11 h-11 rounded-xl bg-base-200 block transition-transform active:scale-95">
                        <img th:if="${moment.owner?.avatar != null}" th:src="${moment.owner.avatar}"
                          th:alt="${moment.owner.displayName}" />
                        <div th:if="${moment.owner?.avatar == null}"
                          class="w-full h-full flex items-center justify-center text-base-content/40 font-semibold"
                          th:text="${moment.owner?.displayName != null ? #strings.substring(moment.owner.displayName, 0, 1) : 'U'}">
                          U</div>
                      </a>
                    </div>
                    <div class="flex-1 min-w-0">
                      <a th:href="@{/authors/{name}(name=${moment.owner.name})}"
                        class="font-semibold text-primary text-sm truncate hover:underline"
                        th:text="${moment.owner?.displayName ?: '匿名用户'}">用户名</a>
                      <div class="flex items-center gap-1.5 mt-0.5 text-xs text-base-content/40">
                        <span th:text="${#temporals.format(moment.spec.releaseTime, 'MM-dd HH:mm')}">11-27 14:00</span>
                        <span th:if="${moment.spec.visible != null and moment.spec.visible.name() == 'PRIVATE'}"
                          class="text-warning/80" title="私密瞬间">
                          <span class="icon-[heroicons--lock-closed] w-3 h-3"></span>
                        </span>
                        <span th:if="${moment.spec.visible != null and moment.spec.visible.name() == 'INTERNAL'}"
                          class="text-info/80" title="仅登录用户可见">
                          <span class="icon-[heroicons--users] w-3 h-3"></span>
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- 文字内容 -->
                  <div th:if="${not #strings.isEmpty(content.html)}"
                    class="text-sm text-base-content leading-relaxed mb-3 [&_a.tag]:hidden" th:utext="${content.html}">
                    今天的天气真好...
                  </div>

                  <!-- 媒体区域 -->
                  <div th:if="${content.medium != null && !content.medium.isEmpty()}" class="moment-media mb-3">
                    <!-- 单图 -->
                    <th:block th:if="${#lists.size(content.medium) == 1}">
                      <th:block th:each="medium : ${content.medium}">
                        <img th:if="${medium.type.name == 'PHOTO'}" th:src="${medium.url}" alt="瞬间图片"
                          class="rounded-xl max-h-72 object-cover cursor-pointer" loading="lazy" />
                        <video th:if="${medium.type.name == 'VIDEO'}" th:src="${medium.url}" controls preload="metadata"
                          class="rounded-xl max-h-72 w-full">
                        </video>
                        <div th:if="${medium.type.name == 'AUDIO'}" class="bg-base-200 rounded-xl p-3">
                          <audio th:src="${medium.url}" controls class="w-full"></audio>
                        </div>
                      </th:block>
                    </th:block>

                    <!-- 多图网格 -->
                    <div th:if="${#lists.size(content.medium) > 1}" class="grid gap-1 rounded-xl overflow-hidden"
                      th:classappend="${#lists.size(content.medium) == 2 or #lists.size(content.medium) == 4} ? 'grid-cols-2' : 'grid-cols-3'">
                      <th:block th:each="medium, stat : ${content.medium}">
                        <div th:if="${medium.type.name == 'PHOTO' && stat.index < 9}"
                          class="aspect-square relative bg-base-200 overflow-hidden cursor-pointer">
                          <img th:src="${medium.url}" alt="瞬间图片"
                            class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                            loading="lazy" />
                          <div th:if="${stat.index == 8 && #lists.size(content.medium) > 9}"
                            class="absolute inset-0 bg-black/50 flex items-center justify-center">
                            <span class="text-white font-semibold"
                              th:text="'+' + (${#lists.size(content.medium)} - 9)">+3</span>
                          </div>
                        </div>
                      </th:block>
                    </div>
                  </div>

                  <!-- 标签 -->
                  <div th:if="${moment.spec.tags != null && !moment.spec.tags.isEmpty()}"
                    class="mb-3 flex flex-wrap gap-1.5">
                    <a th:each="tag : ${moment.spec.tags}" th:href="@{/moments(tag=${tag})}"
                      class="badge badge-sm badge-ghost text-primary" th:text="'#' + ${tag}">#标签</a>
                  </div>

                  <!-- 互动操作 -->
                  <div class="flex items-center gap-4 pt-2 border-t border-base-200 text-sm text-base-content/50">
                    <!-- 点赞按钮 -->
                    <button th:if="${enableUpvote}"
                      class="inline-flex items-center gap-1.5 hover:text-error transition-colors"
                      th:data-moment-name="${moment.metadata.name}" th:data-upvote-count="${moment.stats?.upvote ?: 0}"
                      onclick="handleMomentUpvote(this)">
                      <span class="icon-[heroicons--heart] size-5"></span>
                      <span class="upvote-count" th:text="${moment.stats?.upvote ?: 0}">0</span>
                    </button>
                    <!-- 评论按钮 -->
                    <button th:if="${enableComment}"
                      class="inline-flex items-center gap-1.5 hover:text-primary transition-colors"
                      @click="showComment = !showComment">
                      <span class="icon-[heroicons--chat-bubble-left] size-5"></span>
                      <span th:text="${moment.stats?.totalComment ?: 0}">0</span>
                    </button>
                    <!-- 详情入口 -->
                    <a th:href="@{'/moments/' + ${moment.metadata.name}}"
                      class="inline-flex items-center gap-1.5 hover:text-primary transition-colors" title="查看详情">
                      <span class="icon-[heroicons--arrow-top-right-on-square] size-5"></span>
                    </a>
                  </div>

                  <!-- 评论区 -->
                  <div th:if="${enableComment}" x-show="showComment" x-transition
                    class="mt-3 pt-3 border-t border-base-200">
                    <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}"
                      colorScheme="system">
                    </halo:comment>
                  </div>
                </div>
              </article>

            </th:block>
          </div>

          <!-- 分页 -->
          <div th:if="${moments != null && (moments.hasPrevious() || moments.hasNext())}"
            class="mt-8 flex items-center justify-center">
            <div class="inline-flex items-center p-1 rounded-full bg-base-200/60 backdrop-blur-md">
              <!-- 上一页 -->
              <a th:href="@{${moments.prevUrl}(owner=${param.owner}, tag=${param.tag})}" class="w-9 h-9 flex items-center justify-center rounded-full 
                        text-base-content/60 hover:text-base-content hover:bg-base-100 
                        transition-all duration-200"
                th:classappend="${!moments.hasPrevious()} ? 'opacity-30 pointer-events-none' : ''">
                <span class="icon-[heroicons--chevron-left] w-5 h-5"></span>
              </a>
              <!-- 页码 -->
              <span class="px-4 text-xs font-semibold text-base-content/50 tabular-nums tracking-wide"
                th:text="${moments.page} + ' / ' + ${moments.totalPages}">1 / 1</span>
              <!-- 下一页 -->
              <a th:href="@{${moments.nextUrl}(owner=${param.owner}, tag=${param.tag})}" class="w-9 h-9 flex items-center justify-center rounded-full 
                        text-base-content/60 hover:text-base-content hover:bg-base-100 
                        transition-all duration-200"
                th:classappend="${!moments.hasNext()} ? 'opacity-30 pointer-events-none' : ''">
                <span class="icon-[heroicons--chevron-right] w-5 h-5"></span>
              </a>
            </div>
          </div>

          <!-- 空状态 -->
          <div th:if="${moments == null || moments.total == 0}"
            class="card bg-base-100 shadow-sm rounded-2xl p-12 text-center">
            <span class="icon-[heroicons--camera] size-16 text-base-content/10 mx-auto block mb-4"></span>
            <p class="text-base-content/40">暂无瞬间</p>
          </div>

        </section>

        <!-- 右侧边栏 -->
        <aside th:if="${showSidebar}" class="w-80 space-y-6 hidden lg:block shrink-0 sticky top-20 self-start">
          <th:block th:replace="~{modules/widgets/sidebar :: dynamic(${sidebarCfg})}" />
        </aside>

      </div>
    </div>

    <!-- 发布瞬间模态框 - 启用发布且登录用户可见 -->
    <div id="moment-publish-modal" th:if="${enablePublish && #authorization.expression('isAuthenticated()')}"
      th:with="currentUser = ${contributorFinder.getContributor(#authentication.name)}"
      class="fixed inset-0 bg-black/60 backdrop-blur-sm z-100 items-center justify-center hidden"
      onclick="if(event.target === this) closeMomentModal();" style="display: none;">

      <!-- 引入表情选择器 -->
      <link rel="stylesheet" th:href="@{/assets/emoji/emoji-selector.css}">
      <script th:src="@{/assets/emoji/emoji-selector.js}"></script>

      <div class="w-full max-w-md mx-4 bg-base-100 rounded-2xl shadow-2xl overflow-hidden"
        onclick="event.stopPropagation();">

        <!-- 顶部标题栏 -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-base-200">
          <button type="button" onclick="closeMomentModal()"
            class="text-base-content/60 hover:text-base-content text-sm">
            取消
          </button>
          <span class="font-medium text-base-content">发布瞬间</span>
          <button type="submit" form="moment-publish-form" id="moment-publish-btn"
            class="btn btn-primary btn-sm rounded-full px-4 min-h-0 h-8">
            发布
          </button>
        </div>

        <!-- 模态框内容 -->
        <form id="moment-publish-form">
          <div class="p-4">
            <!-- 用户信息 -->
            <div class="flex items-center gap-3 mb-3">
              <div class="avatar">
                <div class="w-10 h-10 rounded-full ring ring-primary/20 ring-offset-base-100 ring-offset-1">
                  <img th:if="${currentUser.avatar != null}" th:src="${currentUser.avatar}"
                    th:alt="|${currentUser.displayName} 头像|" />
                  <div th:if="${currentUser.avatar == null}"
                    class="w-full h-full bg-primary flex items-center justify-center text-white font-bold"
                    th:text="${#strings.substring(currentUser.displayName, 0, 1)}">U</div>
                </div>
              </div>
              <div>
                <div class="font-medium text-base-content" th:text="${currentUser.displayName}">用户名</div>
                <div class="text-xs text-base-content/50">公开发布</div>
              </div>
            </div>

            <!-- 输入区 -->
            <textarea id="moment-content"
              class="w-full bg-transparent text-base-content placeholder-base-content/40 resize-none border-0 focus:outline-none text-base leading-relaxed min-h-24"
              placeholder="分享新鲜事..." maxlength="1000" oninput="updateCharCount(this)"></textarea>

            <!-- 标签显示区 -->
            <div id="moment-tags-display" class="hidden mt-3">
              <div class="flex flex-wrap gap-2" id="moment-tags-list"></div>
            </div>

            <!-- 媒体预览区 -->
            <div id="moment-media-preview" class="hidden mt-3">
              <div id="moment-media-list"></div>
            </div>
          </div>

          <!-- 底部工具栏 -->
          <div class="px-4 py-3 border-t border-base-200 bg-base-50">
            <div class="flex items-center justify-between">
              <!-- 左侧工具按钮 -->
              <div class="flex items-center gap-0.5">
                <!-- 图片上传 -->
                <button th:if="${enableImageUpload}" type="button" onclick="selectImages()"
                  class="btn btn-ghost btn-sm btn-square hover:bg-primary/10 hover:text-primary" title="图片">
                  <span class="icon-[heroicons--photo] w-5 h-5"></span>
                </button>
                <!-- 视频上传 -->
                <button th:if="${enableVideoUpload}" type="button" onclick="selectVideo()"
                  class="btn btn-ghost btn-sm btn-square hover:bg-primary/10 hover:text-primary" title="视频">
                  <span class="icon-[heroicons--film] w-5 h-5"></span>
                </button>
                <!-- 音频上传 -->
                <button th:if="${enableAudioUpload}" type="button" onclick="selectAudio()"
                  class="btn btn-ghost btn-sm btn-square hover:bg-primary/10 hover:text-primary" title="音频">
                  <span class="icon-[heroicons--musical-note] w-5 h-5"></span>
                </button>
                <button type="button" id="moment-emoji-btn"
                  onclick="showEmojiSelector(document.getElementById('moment-content'), this)"
                  class="btn btn-ghost btn-sm btn-square hover:bg-primary/10 hover:text-primary" title="表情">
                  <span class="icon-[heroicons--face-smile] w-5 h-5"></span>
                </button>
                <button type="button" onclick="toggleTagInput()"
                  class="btn btn-ghost btn-sm btn-square hover:bg-primary/10 hover:text-primary" title="标签">
                  <span class="icon-[heroicons--hashtag] w-5 h-5"></span>
                </button>
              </div>

              <!-- 右侧字数统计 -->
              <span id="moment-char-count" class="text-xs text-base-content/40">0/1000</span>
            </div>

            <!-- 隐藏的文件输入 -->
            <input type="file" id="moment-file-input" accept="" multiple hidden onchange="handleFileSelect(event)" />

            <!-- 标签输入行（默认隐藏） -->
            <div id="moment-tags-input-row" class="mt-3 items-center gap-2" style="display: none;">
              <span class="text-primary">#</span>
              <input type="text" id="moment-tags"
                class="flex-1 bg-transparent border-0 focus:outline-none text-sm placeholder-base-content/40"
                placeholder="输入标签，回车添加"
                onkeydown="if(event.key === 'Enter') { event.preventDefault(); addMomentTag(); }" />
            </div>
          </div>
        </form>
      </div>

      <!-- 发布逻辑 -->
      <script th:inline="javascript">
        (function () {
          'use strict';


          // 当前用户信息
          const CURRENT_USER_NAME = /*[[${currentUser.name}]]*/ '';

          // 已选择的标签
          let selectedTags = [];

          // 已上传的媒体文件
          let uploadedMedia = [];

          // 危险文件扩展名黑名单（禁止上传可执行文件）
          const BLOCKED_EXTENSIONS = ['.svg', '.html', '.htm', '.js', '.exe', '.bat', '.sh', '.php'];

          // 打开模态框
          window.openMomentModal = function () {
            const modal = document.getElementById('moment-publish-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.getElementById('moment-content').focus();
          };

          // 关闭模态框
          window.closeMomentModal = function () {
            const modal = document.getElementById('moment-publish-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            if (window.hideEmojiSelector) hideEmojiSelector();
            // 清空媒体
            uploadedMedia = [];
            updateMediaPreview();
          };

          // 选择图片
          window.selectImages = function () {
            const input = document.getElementById('moment-file-input');
            input.accept = 'image/jpeg,image/jpg,image/png,image/gif,image/webp';
            input.setAttribute('data-category', 'image');
            input.click();
          };

          // 选择视频
          window.selectVideo = function () {
            const input = document.getElementById('moment-file-input');
            input.accept = 'video/mp4,video/webm,video/ogg,video/quicktime';
            input.setAttribute('data-category', 'video');
            input.click();
          };

          // 选择音频
          window.selectAudio = function () {
            const input = document.getElementById('moment-file-input');
            input.accept = 'audio/mpeg,audio/mp3,audio/wav,audio/ogg,audio/aac,audio/m4a';
            input.setAttribute('data-category', 'audio');
            input.click();
          };

          // 检查是否为危险文件
          function isBlockedExtension(fileName) {
            const ext = ('.' + fileName.split('.').pop()).toLowerCase();
            return BLOCKED_EXTENSIONS.includes(ext);
          }

          // 验证 URL 安全性
          function validateUrl(url) {
            if (!url) return false;

            // 禁止危险协议
            const lower = url.toLowerCase();
            if (lower.startsWith('javascript:') || lower.startsWith('data:')) {
              return false;
            }

            return true;
          }

          // 安全验证：HTML 转义
          function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          }

          // 处理文件选择
          window.handleFileSelect = async function (event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            // 显示加载提示
            const publishBtn = document.getElementById('moment-publish-btn');
            const originalText = publishBtn.textContent;
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> 上传中...';

            const errors = [];

            try {
              // 批量上传
              for (const file of files) {
                try {
                  // 安全验证
                  const validation = validateFile(file);
                  if (!validation.valid) {
                    errors.push(`${file.name}: ${validation.error}`);
                    continue;
                  }

                  const media = await uploadFile(file, validation.category);
                  if (media) {
                    uploadedMedia.push(media);
                  }
                } catch (error) {
                  errors.push(`${file.name}: ${error.message}`);
                }
              }

              updateMediaPreview();

              // 显示错误信息
              if (errors.length > 0) {
                alert('部分文件上传失败：\n' + errors.join('\n'));
              }
            } catch (error) {
              console.error('上传失败:', error);
              alert('上传失败，请重试');
            } finally {
              publishBtn.disabled = false;
              publishBtn.textContent = originalText;
              event.target.value = '';
            }
          };

          // 验证文件（仅检查安全性）
          function validateFile(file) {
            if (!file || !(file instanceof File)) {
              return { valid: false, error: '无效的文件' };
            }

            // 禁止可执行文件
            if (isBlockedExtension(file.name)) {
              return { valid: false, error: '禁止上传该类型文件' };
            }

            // 确定文件类别
            let category = 'image';
            if (file.type.startsWith('video/')) category = 'video';
            else if (file.type.startsWith('audio/')) category = 'audio';

            return { valid: true, category };
          }

          // 上传单个文件
          async function uploadFile(file, category) {
            const formData = new FormData();
            formData.append('file', file);

            // 使用 UC API 上传
            const response = await fetch('/apis/uc.api.storage.halo.run/v1alpha1/attachments/-/upload', {
              method: 'POST',
              body: formData
            });

            if (!response.ok) {
              if (response.status === 413) {
                throw new Error('文件太大');
              } else if (response.status === 401 || response.status === 403) {
                throw new Error('无权限上传');
              } else {
                throw new Error('上传失败');
              }
            }

            const attachment = await response.json();

            // 获取 URL
            let url = attachment.status?.permalink || attachment.spec?.permalink;

            // 如果没有 permalink，轮询获取（最多 5 次）
            if (!url && attachment.metadata?.name) {
              for (let i = 0; i < 5; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const checkRes = await fetch(`/api/v1alpha1/attachments/${attachment.metadata.name}`);
                if (checkRes.ok) {
                  const updated = await checkRes.json();
                  url = updated.status?.permalink || updated.spec?.permalink;
                  if (url) break;
                }
              }
            }

            if (!url) {
              throw new Error('未获取到文件地址');
            }

            if (!validateUrl(url)) {
              throw new Error('文件地址不安全');
            }

            // 确定媒体类型
            let type = 'PHOTO';
            if (category === 'video') type = 'VIDEO';
            else if (category === 'audio') type = 'AUDIO';

            return {
              type: type,
              url: url,
              originType: file.type,
              fileName: file.name
            };
          }

          // 更新媒体预览（安全渲染，与展示布局一致）
          function updateMediaPreview() {
            const container = document.getElementById('moment-media-preview');
            const list = document.getElementById('moment-media-list');

            if (uploadedMedia.length === 0) {
              container.classList.add('hidden');
              return;
            }

            container.classList.remove('hidden');

            // 清空现有内容
            list.innerHTML = '';

            const mediaCount = uploadedMedia.length;

            // 单个媒体：大图展示（与展示效果一致）
            if (mediaCount === 1) {
              const media = uploadedMedia[0];
              const wrapper = document.createElement('div');
              wrapper.className = 'relative rounded-xl overflow-hidden bg-base-200 group';

              if (media.type === 'PHOTO') {
                const img = document.createElement('img');
                img.src = media.url;
                img.alt = '预览';
                img.className = 'rounded-xl max-h-72 object-cover w-auto mx-auto';
                img.loading = 'lazy';
                wrapper.appendChild(img);
              } else if (media.type === 'VIDEO') {
                const video = document.createElement('video');
                video.src = media.url;
                video.className = 'rounded-xl max-h-72 w-full';
                video.preload = 'metadata';
                wrapper.appendChild(video);

                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 flex items-center justify-center bg-black/30 pointer-events-none';
                overlay.innerHTML = '<span class="icon-[heroicons--play-circle] w-16 h-16 text-white"></span>';
                wrapper.appendChild(overlay);
              } else if (media.type === 'AUDIO') {
                wrapper.className = 'bg-base-200 rounded-xl p-3';
                const audio = document.createElement('audio');
                audio.src = media.url;
                audio.controls = true;
                audio.className = 'w-full';
                wrapper.appendChild(audio);
              }

              // 删除按钮
              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'absolute top-2 right-2 w-7 h-7 rounded-full bg-error text-error-content flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 shadow-lg';
              deleteBtn.innerHTML = '<span class="icon-[heroicons--x-mark] w-5 h-5"></span>';
              deleteBtn.onclick = () => removeMedia(0);
              wrapper.appendChild(deleteBtn);

              list.appendChild(wrapper);
            }
            // 多个媒体：网格展示（2/4张=2列，其他=3列）
            else {
              // 确定网格列数
              const gridCols = (mediaCount === 2 || mediaCount === 4) ? 2 : 3;
              list.className = `grid gap-1 rounded-xl overflow-hidden grid-cols-${gridCols}`;

              uploadedMedia.forEach((media, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'aspect-square relative bg-base-200 overflow-hidden group';

                if (media.type === 'PHOTO') {
                  const img = document.createElement('img');
                  img.src = media.url;
                  img.alt = '预览';
                  img.className = 'w-full h-full object-cover';
                  img.loading = 'lazy';
                  wrapper.appendChild(img);
                } else if (media.type === 'VIDEO') {
                  const video = document.createElement('video');
                  video.src = media.url;
                  video.className = 'w-full h-full object-cover';
                  video.preload = 'metadata';
                  wrapper.appendChild(video);

                  const overlay = document.createElement('div');
                  overlay.className = 'absolute inset-0 flex items-center justify-center bg-black/30 pointer-events-none';
                  overlay.innerHTML = '<span class="icon-[heroicons--play-circle] w-10 h-10 text-white"></span>';
                  wrapper.appendChild(overlay);
                } else if (media.type === 'AUDIO') {
                  wrapper.className += ' flex flex-col items-center justify-center p-2';
                  const icon = document.createElement('span');
                  icon.className = 'icon-[heroicons--musical-note] w-10 h-10 text-base-content/40 mb-1';
                  wrapper.appendChild(icon);

                  const fileName = document.createElement('div');
                  fileName.className = 'text-xs text-base-content/60 truncate w-full text-center px-1';
                  fileName.textContent = media.fileName || '音频';
                  wrapper.appendChild(fileName);
                }

                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'absolute top-1 right-1 w-6 h-6 rounded-full bg-error text-error-content flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-10 shadow-lg';
                deleteBtn.innerHTML = '<span class="icon-[heroicons--x-mark] w-4 h-4"></span>';
                deleteBtn.onclick = () => removeMedia(index);
                wrapper.appendChild(deleteBtn);

                list.appendChild(wrapper);
              });
            }
          }

          // 移除媒体
          window.removeMedia = function (index) {
            uploadedMedia.splice(index, 1);
            updateMediaPreview();
          };

          // 更新字数统计（实时验证）
          window.updateCharCount = function (textarea) {
            const count = textarea.value.length;
            const counter = document.getElementById('moment-char-count');
            counter.textContent = count + '/1000';

            // 超出限制时变红
            if (count > 1000) {
              counter.classList.add('text-error');
            } else {
              counter.classList.remove('text-error');
            }
          };

          // 切换标签输入
          window.toggleTagInput = function () {
            const row = document.getElementById('moment-tags-input-row');
            if (row.style.display === 'none') {
              row.style.display = 'flex';
              document.getElementById('moment-tags').focus();
            } else {
              row.style.display = 'none';
            }
          };

          // 添加标签
          window.addMomentTag = function () {
            const input = document.getElementById('moment-tags');
            const tag = input.value.trim();

            // 安全验证
            if (!tag) return;

            // 限制标签长度
            if (tag.length > 50) {
              alert('标签长度不能超过 50 个字符');
              return;
            }

            // 限制标签数量
            if (selectedTags.length >= 10) {
              alert('最多只能添加 10 个标签');
              return;
            }

            // 过滤特殊字符（防止 XSS）
            const safeTag = tag.replace(/[<>'"&]/g, '');
            if (safeTag.length === 0) {
              alert('标签包含非法字符');
              return;
            }

            if (!selectedTags.includes(safeTag)) {
              selectedTags.push(safeTag);
              updateTagsDisplay();
            }
            input.value = '';
          };

          // 移除标签
          window.removeMomentTag = function (index) {
            selectedTags.splice(index, 1);
            updateTagsDisplay();
          };

          // 更新标签显示（安全渲染）
          function updateTagsDisplay() {
            const container = document.getElementById('moment-tags-display');
            const list = document.getElementById('moment-tags-list');

            if (selectedTags.length === 0) {
              container.classList.add('hidden');
              return;
            }

            container.classList.remove('hidden');

            // 使用 DOM API 创建元素（防止 XSS）
            list.innerHTML = '';
            selectedTags.forEach((tag, index) => {
              const badge = document.createElement('span');
              badge.className = 'badge badge-primary badge-outline gap-1';

              const tagText = document.createElement('span');
              tagText.textContent = '#' + tag; // textContent 自动转义
              badge.appendChild(tagText);

              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.textContent = '×';
              removeBtn.className = 'hover:text-error';
              removeBtn.onclick = () => removeMomentTag(index);
              badge.appendChild(removeBtn);

              list.appendChild(badge);
            });
          }

          // 发布瞬间
          async function publishMoment(content, tags, media) {
            // 安全验证：标签
            const safeTags = (tags || [])
              .filter(tag => typeof tag === 'string' && tag.length > 0 && tag.length <= 50)
              .map(tag => escapeHtml(tag.trim()))
              .slice(0, 10);

            // 安全验证：媒体 URL
            const safeMedia = (media || []).filter(m => {
              return m &&
                typeof m.url === 'string' &&
                validateUrl(m.url) &&
                ['PHOTO', 'VIDEO', 'AUDIO', 'POST'].includes(m.type);
            });

            const momentName = 'moment-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const momentData = {
              apiVersion: 'moment.halo.run/v1alpha1',
              kind: 'Moment',
              metadata: {
                name: momentName,
                labels: { 'moment.halo.run/visible': 'PUBLIC' }
              },
              spec: {
                approved: true,
                approvedTime: new Date().toISOString(),
                content: {
                  raw: content.trim(),
                  html: escapeHtml(content.trim()).replace(/\n/g, '<br>') // HTML 转义
                },
                owner: CURRENT_USER_NAME,
                visible: 'PUBLIC',
                releaseTime: new Date().toISOString(),
                tags: safeTags
              }
            };

            // 添加媒体数据
            if (safeMedia.length > 0) {
              momentData.spec.content.medium = safeMedia.map(m => ({
                type: m.type,
                url: m.url, // 已在 uploadFile 中转义
                originType: m.originType // 已在 uploadFile 中转义
              }));
            }

            let response;
            try {
              response = await fetch('/apis/moment.halo.run/v1alpha1/moments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(momentData),
                signal: AbortSignal.timeout(30000) // 30秒超时
              });
            } catch (error) {
              if (error.name === 'AbortError') {
                throw new Error('发布超时，请重试');
              }
              throw new Error('网络错误');
            }

            if (!response.ok) {
              // 不泄露详细错误
              if (response.status === 401 || response.status === 403) {
                throw new Error('无权限发布');
              } else if (response.status === 400) {
                throw new Error('数据格式错误');
              } else {
                throw new Error('发布失败，请重试');
              }
            }
            return true;
          }

          // 局部刷新瞬间列表
          async function refreshMomentsList() {
            try {
              const response = await fetch(window.location.href);
              const html = await response.text();
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');

              const newList = doc.getElementById('moments-list');
              const currentList = document.getElementById('moments-list');

              if (newList && currentList) {
                currentList.innerHTML = newList.innerHTML;
              }
            } catch (error) {
              console.error('刷新失败:', error);
              window.location.reload();
            }
          }

          // 表单提交
          document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('moment-publish-form');
            if (!form) return;

            form.addEventListener('submit', async function (e) {
              e.preventDefault();

              const contentInput = document.getElementById('moment-content');
              const publishBtn = document.getElementById('moment-publish-btn');
              const content = contentInput.value.trim();

              // 允许纯媒体瞬间（没有文字也可以发布）
              if (!content && uploadedMedia.length === 0) {
                alert('请输入内容或上传媒体');
                return;
              }

              // 使用已添加的标签和媒体
              const tags = [...selectedTags];
              const media = [...uploadedMedia];

              // 显示加载状态
              publishBtn.disabled = true;
              publishBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span>';

              try {
                const success = await publishMoment(content, tags, media);

                if (success) {
                  // 清空并关闭
                  contentInput.value = '';
                  selectedTags = [];
                  uploadedMedia = [];
                  updateTagsDisplay();
                  updateMediaPreview();
                  document.getElementById('moment-char-count').textContent = '0/1000';
                  document.getElementById('moment-tags').value = '';
                  document.getElementById('moment-tags-input-row').style.display = 'none';
                  closeMomentModal();

                  // 刷新列表
                  setTimeout(refreshMomentsList, 500);
                }
              } catch (err) {
                console.error('发布异常:', err);
                alert('发布失败: ' + err.message);
              } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = '发布';
              }
            });

            // Ctrl+Enter 快捷发布
            document.getElementById('moment-content')?.addEventListener('keydown', function (e) {
              if (e.ctrlKey && e.key === 'Enter') {
                form.dispatchEvent(new Event('submit'));
              }
            });
          });
        })();
      </script>
    </div>

  </th:block>

</th:block>