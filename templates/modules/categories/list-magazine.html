<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ============================================= -->
<!--   Magazine 杂志风格：纯图片展示 + 悬浮信息     -->
<!--   特点：默认纯图片，悬浮显示标题与元信息       -->
<!-- ============================================= -->

<section th:fragment="magazine(posts, settings)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <article th:each="post : ${posts.items}"
    th:with="isPinned = ${post.spec.pinned == true},
                    isPrivate = ${post.spec.visible != null and post.spec.visible.name() == 'PRIVATE' and currentUser != null and currentUser.metadata.name == post.spec.owner},
                    isLocked = ${post.metadata.annotations != null and post.metadata.annotations['content.halo.run/content-restriction'] != null and post.metadata.annotations['content.halo.run/content-restriction'] != ''}"
    class="group relative overflow-hidden rounded-[2rem] shadow-lg border border-base-content/5 hover:shadow-2xl transition-all duration-700 ease-[cubic-bezier(0.25,0.1,0.25,1)]">

    <!-- 封面计算 (Context-Aware Fix) -->
    <th:block th:with="
        nested = ${settings?.cover_fallback},
        flatEnable = ${settings?.cover_fallback_enable},
        flatMode = ${settings?.cover_fallback_mode},
        flatUrl = ${settings?.cover_fallback_url},
        enable = ${nested != null ? (nested.enable ?: false) : (flatEnable ?: false)},
        mode = ${nested != null ? (nested.mode ?: 'missing_only') : (flatMode ?: 'missing_only')},
        defaultImg = ${nested != null ? nested.default_image : flatUrl},
        actual=${post.spec.cover},
        actualOk=${actual != null and not #strings.isEmpty(actual) ? actual : null},
        coverUrl=${(enable == true) ? ((mode == 'always' and defaultImg != null) ? defaultImg : (actualOk != null ? actualOk : defaultImg)) : actualOk}
    ">
      <!-- 背景大图：16:10 比例 -->
      <div class="relative aspect-video overflow-hidden">
        <a th:href="@{${post.status.permalink}}" class="absolute inset-0 block">
          <img th:if="${coverUrl != null}" th:src="${coverUrl}" th:alt="|${post.spec.title} 的封面|" loading="lazy"
            class="absolute inset-0 w-full h-full object-cover transform scale-100 group-hover:scale-105 transition-transform duration-1000 ease-[cubic-bezier(0.25,0.1,0.25,1)]" />
          <!-- 无封面占位 -->
          <div th:if="${coverUrl == null}"
            class="absolute inset-0 bg-gradient-to-br from-primary/15 via-secondary/10 to-accent/15 grid place-items-center">
            <span class="icon-[heroicons--photo] w-16 h-16 text-primary/30"></span>
          </div>
        </a>

        <!-- 全局安全遮罩：确保浅色图片上的白字也能看清 -->
        <div class="absolute inset-0 bg-black/10 pointer-events-none"></div>

        <!-- 置顶角标 -->
        <span th:if="${isPinned}"
          class="absolute top-3 left-3 z-10 px-2 py-0.5 rounded-md text-[10px] font-bold text-white bg-gradient-to-r from-pink-500 to-rose-500 shadow-sm backdrop-blur-md">置顶</span>

        <!-- 渐变遮罩：双层设计 (对比度增强版) -->
        <!-- 1. 默认状态：底部渐变加深 (from-black/80 via-black/40)，保护常驻信息 -->
        <div
          class="absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t from-black/80 via-black/40 to-transparent transition-opacity duration-500 group-hover:opacity-0 pointer-events-none">
        </div>

        <!-- 2. 悬浮状态：全屏沉浸渐变 (加深至 from-black/90 via-black/60)，确保标题绝对清晰 -->
        <div
          class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 ease-in-out pointer-events-none">
        </div>

        <!-- 内容层：Hover-Reveal 交互 -->
        <div class="absolute bottom-0 left-0 right-0 p-8 flex flex-col justify-end pointer-events-none">

          <!-- 揭示区域：使用 Grid Rows 实现顺滑高度动画 -->
          <div
            class="grid grid-rows-[0fr] group-hover:grid-rows-[1fr] transition-all duration-700 ease-[cubic-bezier(0.25,0.1,0.25,1)]">
            <div class="overflow-hidden">
              <div class="pb-4 flex flex-col items-start gap-3">
                <!-- 标题：优先上浮 (delay-75)，增加 line-clamp-2 防止溢出 -->
                <h3
                  class="transform translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-700 delay-75 ease-out
                         text-xl md:text-2xl font-bold leading-tight drop-shadow-lg tracking-tight text-white pointer-events-auto line-clamp-2">
                  <a th:href="@{${post.status.permalink}}" class="hover:text-primary transition-colors"
                    th:text="${post.spec.title}">文章标题</a>
                </h3>

                <!-- 分类胶囊：稍后跟随 (delay-150) -->
                <div th:if="${!#lists.isEmpty(post.categories)}" th:with="firstCat=${post.categories[0]}"
                  class="transform translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-700 delay-150 ease-out pointer-events-auto">
                  <a th:href="@{${firstCat.status.permalink}}"
                    class="inline-block px-3 py-1 rounded-full bg-white/20 hover:bg-white/30 backdrop-blur-md text-[10px] font-bold text-white uppercase tracking-wider transition-colors shadow-sm"
                    th:text="${firstCat.spec.displayName}">分类</a>
                </div>
              </div>
            </div>
          </div>

          <!-- 常驻元信息：默认可见，白色 -->
          <div
            class="flex flex-wrap items-center gap-4 text-sm text-white/90 font-medium pt-2 border-t border-white/0 group-hover:border-white/10 transition-colors duration-500">
            <!-- 日期 -->
            <span class="inline-flex items-center gap-1.5">
              <span class="icon-[heroicons--calendar-days] w-4 h-4 opacity-80"></span>
              <time th:text="${#dates.format(post.spec.publishTime,'MMMM dd, yyyy')}">January 01, 2025</time>
            </span>

            <span class="w-1 h-1 rounded-full bg-white/40"></span>

            <!-- 浏览量 -->
            <span class="inline-flex items-center gap-1.5">
              <span class="icon-[heroicons--eye] w-4 h-4 opacity-80"></span>
              <span th:text="${post.stats.visit ?: 0}">0</span>
            </span>

            <!-- 点赞 -->
            <span class="inline-flex items-center gap-1.5">
              <span class="icon-[heroicons--heart] w-4 h-4 opacity-80"></span>
              <span th:text="${post.stats.upvote ?: 0}">0</span>
            </span>
          </div>
        </div>
      </div>
    </th:block>
  </article>
</section>

</html>