<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">

<!-- ========================================== -->
<!--   Steam Mini Profile 卡片组件              -->
<!--   使用 REST API 异步加载，不阻塞页面渲染    -->
<!-- ========================================== -->

<th:block th:fragment="card">
  <!-- Steam 卡片容器 - 使用 Alpine.js 异步加载 -->
  <div x-data="steamCard()" x-init="init()" class="steam-card-wrapper">
    
    <!-- 加载状态 -->
    <div x-show="loading" class="card bg-base-100/80 backdrop-blur-xl shadow-lg border border-base-content/5 rounded-[1.5rem] overflow-hidden p-5">
      <div class="flex items-center gap-4 animate-pulse">
        <div class="w-14 h-14 rounded-xl bg-base-content/10"></div>
        <div class="flex-1 space-y-2">
          <div class="h-4 bg-base-content/10 rounded w-24"></div>
          <div class="h-3 bg-base-content/10 rounded w-16"></div>
        </div>
      </div>
      <div class="flex items-center pt-3 mt-3 border-t border-base-content/5">
        <div class="flex-1 text-center space-y-1">
          <div class="h-2 bg-base-content/10 rounded w-6 mx-auto"></div>
          <div class="h-3 bg-base-content/10 rounded w-8 mx-auto"></div>
        </div>
        <div class="flex-1 text-center space-y-1">
          <div class="h-2 bg-base-content/10 rounded w-6 mx-auto"></div>
          <div class="h-3 bg-base-content/10 rounded w-8 mx-auto"></div>
        </div>
        <div class="flex-1 text-center space-y-1">
          <div class="h-2 bg-base-content/10 rounded w-6 mx-auto"></div>
          <div class="h-3 bg-base-content/10 rounded w-8 mx-auto"></div>
        </div>
      </div>
    </div>

    <!-- 实际内容 -->
    <a x-show="!loading && profile" x-cloak href="/steam"
       class="card block bg-base-100/80 backdrop-blur-xl shadow-lg border border-base-content/5 rounded-[1.5rem] overflow-hidden group hover:shadow-xl transition-all duration-300 relative"
       :class="profile?.playing ? 'ring-2 ring-accent/50 hover:ring-accent/70' : 'hover:border-primary/20'">

      <!-- 游戏中背景 -->
      <div x-show="gameHeaderUrl" class="absolute inset-0 z-0">
        <img :src="gameHeaderUrl"
             class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
             referrerpolicy="no-referrer"
             @error="gameHeaderUrl = null" />
        <div class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/50 to-black/20"></div>
      </div>

      <!-- Steam Logo 水印 -->
      <div x-show="!profile?.playing"
           class="absolute -right-6 -bottom-6 text-base-content/5 rotate-[-15deg] pointer-events-none z-0 transition-all duration-500 group-hover:rotate-[-10deg] group-hover:scale-110 group-hover:text-base-content/8">
        <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0C5.373 0 0 5.373 0 12c0 3.167 1.223 5.922 3.167 8.08L6.8 15.6c-.347-.723-.593-1.468-.593-2.31c0-2.872 2.328-5.2 5.2-5.2c2.872 0 5.2 2.328 5.2 5.2s-2.328 5.2-5.2 5.2c-.407 0-.796-.106-1.168-.2l-2.73 3.937A11.96 11.96 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0m.593 14.4c-.722 0-1.2-.478-1.2-1.2c0-.722.478-1.2 1.2-1.2s1.2.478 1.2 1.2s-.478 1.2-1.2 1.2m0-3.6c-2.003 0-3.6 1.6-3.6 3.6c0 1.215.545 2.155 1.348 2.805l-2.09 3.016a2.4 2.4 0 0 1-.362-.023a2.4 2.4 0 1 1 1.706-3.924l2.257-3.256c.236.052.48.082.74.082c1.997 0 3.6-1.603 3.6-3.6s-1.603-3.6-3.6-3.6" />
        </svg>
      </div>

      <!-- 内容层 -->
      <div class="relative z-10 p-5 flex items-center gap-4">
        <!-- 头像 -->
        <div class="relative shrink-0">
          <div class="w-14 h-14 rounded-xl overflow-hidden ring-2 shadow-md transition-all"
               :class="profile?.playing ? 'ring-accent' : ((profile?.summary?.personaState || profile?.summary?.personastate) == 1 ? 'ring-success' : 'ring-base-content/10')">
            <img :src="profile?.summary?.avatar || profile?.summary?.avatarfull || profile?.summary?.avatarFull" :alt="profile?.summary?.personaname || profile?.summary?.personaName"
                 class="w-full h-full object-cover" referrerpolicy="no-referrer" />
          </div>
          <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full ring-2 ring-base-100"
               :class="profile?.playing ? 'bg-accent animate-pulse' : ((profile?.summary?.personaState || profile?.summary?.personastate) == 1 ? 'bg-success' : 'bg-base-content/30')">
          </div>
        </div>

        <!-- 用户信息 -->
        <div class="flex-1 min-w-0">
          <h3 class="text-sm font-bold truncate"
              :class="profile?.playing ? 'text-white' : 'text-base-content'"
              x-text="profile?.summary?.personaname || profile?.summary?.personaName || 'Steam User'"></h3>
          <div class="mt-0.5 text-xs truncate">
            <span x-show="profile?.playing" class="inline-flex items-center gap-1 text-accent font-medium">
              <span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse shrink-0"></span>
              <span class="truncate" x-text="profile?.statusText">正在游玩</span>
            </span>
            <span x-show="!profile?.playing && profile?.summary?.personaState == 1" class="text-success">在线</span>
            <span x-show="!profile?.playing && profile?.summary?.personaState != 1" class="text-base-content/50" x-text="profile?.statusText">离线</span>
          </div>
        </div>
      </div>

      <!-- 底部统计栏 -->
      <div class="relative z-10 px-4 pb-3">
        <div class="flex items-center pt-2 border-t"
             :class="profile?.playing ? 'border-white/20' : 'border-base-content/5'">
          <div class="flex-1 text-center">
            <div class="text-[10px] font-medium" :class="profile?.playing ? 'text-white/60' : 'text-base-content/40'">Lv</div>
            <div class="text-xs font-bold" :class="profile?.playing ? 'text-white' : 'text-base-content'" x-text="badges?.playerLevel || '-'"></div>
          </div>
          <div class="w-px h-4" :class="profile?.playing ? 'bg-white/20' : 'bg-base-content/10'"></div>
          <div class="flex-1 text-center">
            <div class="text-[10px] font-medium" :class="profile?.playing ? 'text-white/60' : 'text-base-content/40'">游戏</div>
            <div class="text-xs font-bold" :class="profile?.playing ? 'text-white' : 'text-base-content'" x-text="stats?.totalGames || '-'"></div>
          </div>
          <div class="w-px h-4" :class="profile?.playing ? 'bg-white/20' : 'bg-base-content/10'"></div>
          <div class="flex-1 text-center">
            <div class="text-[10px] font-medium" :class="profile?.playing ? 'text-white/60' : 'text-base-content/40'">时长</div>
            <div class="text-xs font-bold" :class="profile?.playing ? 'text-white' : 'text-base-content'" x-text="stats ? Math.floor(stats.totalPlaytimeMinutes / 60) + 'h' : '-'"></div>
          </div>
        </div>
      </div>
    </a>

    <!-- 错误/无数据状态 - 不显示任何内容 -->
  </div>

  <script>
    // Steam 卡片缓存配置
    const STEAM_CARD_CACHE_KEY = 'steam_card_cache';
    const STEAM_CARD_CACHE_TTL = 3 * 60 * 1000; // 3分钟

    const steamCardCache = {
      get(key) {
        try {
          const data = localStorage.getItem(`${STEAM_CARD_CACHE_KEY}_${key}`);
          if (!data) return null;
          const { value, expiry } = JSON.parse(data);
          if (Date.now() > expiry) {
            console.log(`[Steam Card] 缓存过期: ${key}`);
            localStorage.removeItem(`${STEAM_CARD_CACHE_KEY}_${key}`);
            return null;
          }
          console.log(`[Steam Card] 命中缓存: ${key}`);
          return value;
        } catch {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(`${STEAM_CARD_CACHE_KEY}_${key}`, JSON.stringify({
            value,
            expiry: Date.now() + STEAM_CARD_CACHE_TTL
          }));
          console.log(`[Steam Card] 写入缓存: ${key}`);
        } catch (e) {
          console.warn('[Steam Card] 缓存写入失败:', e);
        }
      }
    };

    document.addEventListener('alpine:init', () => {
      // 防止重复注册
      if (Alpine.data && Alpine._steamCardRegistered) return;
      Alpine._steamCardRegistered = true;

      Alpine.data('steamCard', () => ({
        loading: true,
        profile: null,
        stats: null,
        badges: null,
        gameHeaderUrl: null,
        _initialized: false,

        async init() {
          // 防止重复初始化
          if (this._initialized) {
            console.log('[Steam Card] 跳过重复初始化');
            return;
          }
          this._initialized = true;

          console.log('[Steam Card] 初始化开始');
          const startTime = performance.now();

          try {
            // 尝试从缓存读取
            const cachedProfile = steamCardCache.get('profile');
            const cachedStats = steamCardCache.get('stats');
            const cachedBadges = steamCardCache.get('badges');

            // 如果全部命中缓存，直接使用
            if (cachedProfile && cachedStats && cachedBadges) {
              console.log('[Steam Card] 全部使用缓存数据');
              this.profile = cachedProfile;
              this.stats = cachedStats;
              this.badges = cachedBadges;
            } else {
              // 否则请求 API
              console.log('[Steam Card] 开始请求 API...');
              const fetchStart = performance.now();

              const [profileRes, statsRes, badgesRes] = await Promise.all([
                cachedProfile ? Promise.resolve(cachedProfile) : 
                  fetch('/apis/api.steam.halo.run/v1alpha1/profile')
                    .then(r => { console.log(`[Steam Card] profile 响应: ${r.status}`); return r.ok ? r.json() : null; })
                    .catch(e => { console.error('[Steam Card] profile 请求失败:', e); return null; }),
                cachedStats ? Promise.resolve(cachedStats) :
                  fetch('/apis/api.steam.halo.run/v1alpha1/stats')
                    .then(r => { console.log(`[Steam Card] stats 响应: ${r.status}`); return r.ok ? r.json() : null; })
                    .catch(e => { console.error('[Steam Card] stats 请求失败:', e); return null; }),
                cachedBadges ? Promise.resolve(cachedBadges) :
                  fetch('/apis/api.steam.halo.run/v1alpha1/badges')
                    .then(r => { console.log(`[Steam Card] badges 响应: ${r.status}`); return r.ok ? r.json() : null; })
                    .catch(e => { console.error('[Steam Card] badges 请求失败:', e); return null; })
              ]);

              console.log(`[Steam Card] API 请求耗时: ${(performance.now() - fetchStart).toFixed(0)}ms`);

              this.profile = profileRes;
              this.stats = statsRes;
              this.badges = badgesRes;

              // 写入缓存
              if (profileRes) steamCardCache.set('profile', profileRes);
              if (statsRes) steamCardCache.set('stats', statsRes);
              if (badgesRes) steamCardCache.set('badges', badgesRes);
            }

            // 设置游戏背景图
            const gameId = this.profile?.summary?.gameId || this.profile?.summary?.gameid;
            if (this.profile?.playing && gameId) {
              this.gameHeaderUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${gameId}/header.jpg`;
              console.log(`[Steam Card] 正在游玩, gameId: ${gameId}`);
            }

            console.log('[Steam Card] 数据加载完成:', {
              profile: !!this.profile,
              stats: !!this.stats,
              badges: !!this.badges,
              playing: this.profile?.playing,
              status: this.profile?.statusText
            });

          } catch (e) {
            console.error('[Steam Card] 加载失败:', e);
          } finally {
            this.loading = false;
            console.log(`[Steam Card] 总耗时: ${(performance.now() - startTime).toFixed(0)}ms`);
          }
        }
      }));
    });
  </script>
</th:block>

</html>
